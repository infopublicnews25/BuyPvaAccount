<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BuyPvaAccount</title>
    <meta name="description" content="Admin dashboard for BuyPvaAccount. Manage orders, users, products, and notifications securely.">
    <meta name="keywords" content="admin, dashboard, BuyPvaAccount, management, orders, users">
    <meta name="author" content="BuyPvaAccount">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõí</text></svg>">
    <script src="config.js"></script>
    <script src="staff-guard.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.3.1/sha1.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
        }

        .login-page {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-page.show {
            display: flex;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 400px;
        }

        .login-box h2 {
            margin-bottom: 24px;
            text-align: center;
            color: #333;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-edit {
            background: #ed8936;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .error {
            color: #f56565;
            text-align: center;
            margin-bottom: 16px;
            display: none;
            font-size: 14px;
        }

        .dashboard {
            display: none;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .notification-btn {
            position: relative;
            background: #f7fafc;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-btn:hover {
            background: #edf2f7;
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .notification-wrapper {
            position: relative;
            display: inline-block;
        }

        .notification-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 10px);
            width: 360px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
            display: none;
            z-index: 1200;
            overflow: hidden;
        }

        .notification-wrapper.open .notification-dropdown {
            display: block;
        }

        .notification-wrapper:hover .notification-dropdown {
            display: block;
        }

        .notification-dropdown-header {
            padding: 12px 14px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .notification-dropdown-count {
            font-weight: 700;
            color: #667eea;
        }

        .notification-dropdown-list {
            max-height: 340px;
            overflow: auto;
        }

        .notification-dropdown-item {
            padding: 12px 14px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }

        .notification-dropdown-item:hover {
            background: #f7fafc;
        }

        .notification-dropdown-title {
            font-size: 13px;
            font-weight: 700;
            color: #2d3748;
        }

        .notification-dropdown-message {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notification-dropdown-time {
            font-size: 11px;
            color: #a0aec0;
            margin-top: 6px;
        }

        .notification-dropdown-footer {
            padding: 10px 14px;
            border-top: 1px solid #e2e8f0;
            background: #f7fafc;
            text-align: right;
        }

        .notification-dropdown-footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 700;
            font-size: 13px;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f7fafc;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 650px;
            margin: 50px auto;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-in-stock {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-out {
            background: #fed7d7;
            color: #742a2a;
        }

        .news-item {
            padding: 16px 0;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .news-content {
            flex: 1;
        }

        .news-date {
            font-weight: 600;
            color: #ed8936;
            margin-right: 12px;
            font-size: 14px;
        }

        .news-actions {
            display: flex;
            gap: 8px;
        }

        .category-tag {
            display: inline-block;
            background: #ebf4ff;
            color: #2c5282;
            padding: 8px 16px;
            border-radius: 8px;
            margin: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .category-tag button {
            background: none;
            border: none;
            color: #c53030;
            margin-left: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 22px;
            color: #2d3748;
        }
    </style>

    <script>
        // If an editor is already logged in, they must not access admin panel.
        (async function () {
            try {
                if (!window.StaffGuard) return;
                await window.StaffGuard.require({
                    allowAnonymous: true,
                    disallowRoles: ['editor'],
                    redirectOnDeny: 'dashboard.html',
                    loginPage: 'admin.html'
                });
            } catch (e) {}
        })();
    </script>
</head>

<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-box">
            <h2>üîê Admin Login</h2>
            <div id="loginError" class="error"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group" id="twofaGroup" style="display: none;">
                    <label>2FA Code</label>
                    <input type="text" id="twofaCode" placeholder="Enter 6-digit code" maxlength="6" pattern="\d{6}" inputmode="numeric">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard" style="display: none;">
        <div class="header">
            <h1>üìä Admin Dashboard</h1>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="window.location.href='ordermanagement.html'">üì¶ Order
                    Management</button>
                <button class="btn btn-success" onclick="window.location.href='user-management.html'">üë• User Management</button>
                <button class="btn btn-secondary" onclick="window.location.href='payment-settings.html'">üí≥ Payment Settings</button>
                <button class="btn btn-info" onclick="window.open('dashboard.html', '_blank')">üñ•Ô∏è Website Dashboard</button>
                <div class="notification-wrapper" id="notificationWrapper">
                    <div class="notification-btn" id="notificationBell" role="button" tabindex="0" aria-label="Open notifications">
                        üîî
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </div>
                    <div class="notification-dropdown" id="notificationDropdown" aria-label="Notifications preview">
                        <div class="notification-dropdown-header">
                            <span>Notifications</span>
                            <span class="notification-dropdown-count" id="notificationDropdownCount">0</span>
                        </div>
                        <div class="notification-dropdown-list" id="notificationDropdownList"></div>
                        <div class="notification-dropdown-footer">
                            <a href="notifications.html">View all</a>
                        </div>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('products')">üì¶ Products</button>
                <button class="tab" onclick="switchTab('categories')">üìÇ Categories</button>
                <button class="tab" onclick="switchTab('users')">üë• Users</button>
                <button class="tab" onclick="switchTab('news')">üì∞ News</button>
                <button class="tab" onclick="switchTab('files')">üìÅ File Manager</button>
                <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>

            <!-- Categories Tab -->
            <div id="categoriesTab" class="tab-content">
                <div class="section-header">
                    <h2>üìÇ Category Management</h2>
                </div>
                <div style="margin-bottom: 30px; padding: 24px; background: #f7fafc; border-radius: 12px;">
                    <h3 style="margin-bottom: 16px;">üìÇ Manage Product Categories</h3>
                    <form onsubmit="addCategory(event)">
                        <div class="form-group">
                            <label>Add New Category</label>
                            <div style="display: flex; gap: 12px;">
                                <input type="text" id="newCategory" placeholder="Enter category name" style="flex: 1;">
                                <button type="submit" class="btn btn-success">Add Category</button>
                            </div>
                        </div>
                    </form>
                    <div id="categoriesList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="productsTab" class="tab-content active">
                <div class="section-header">
                    <h2>Products Management</h2>
                    <button class="btn btn-success" onclick="openProductModal()">‚ûï Add New Product</button>
                </div>
                <table id="productsTableContainer">
                    <thead>
                        <tr>
                            <th>Product Title</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable"></tbody>
                </table>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <div class="section-header">
                    <h2>User Management</h2>
                    <button class="btn btn-success" onclick="openUserModal()">‚ûï Add New User</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>

            <!-- News Tab -->
            <div id="newsTab" class="tab-content">
                <div class="section-header">
                    <h2>News & Updates</h2>
                </div>
                <form onsubmit="addNews(event)"
                    style="margin-bottom: 24px; padding: 24px; background: #f7fafc; border-radius: 12px;">
                    <h3 id="newsFormTitle" style="margin-bottom: 16px;">Add News/Update</h3>
                    <input type="hidden" id="newsEditIndex" value="-1">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="text" id="newsDate" value="Nov 2025" required>
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <textarea id="newsContent" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success" id="newsSubmitBtn">Add News</button>
                    <button type="button" class="btn btn-secondary" id="newsCancelBtn" onclick="cancelNewsEdit()"
                        style="display: none;">Cancel</button>
                </form>
                <div id="newsList"></div>
            </div>

            <!-- File Manager Tab -->
            <div id="filesTab" class="tab-content">
                <div class="section-header">
                    <h2>File Manager</h2>
                    <div>
                        <button class="btn btn-primary" onclick="openFileManager()">üìÅ Open Full File Manager</button>
                        <button class="btn btn-success" onclick="window.open('dashboard.html', '_blank')">üñ•Ô∏è Website Dashboard</button>
                    </div>
                </div>
                <div style="padding: 24px; background: #f7fafc; border-radius: 12px;">
                    <h3>Quick File Access</h3>
                    <p style="margin-bottom: 16px; color: #666;">Access the full file manager for complete website management, or use the website dashboard for a WordPress-like interface.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="file-access-card" onclick="navigateToFolder('backend')" style="cursor: pointer; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">‚öôÔ∏è</div>
                            <div style="font-weight: 600;">Backend</div>
                            <div style="font-size: 12px; color: #666;">Server files & API</div>
                        </div>
                        <div class="file-access-card" onclick="navigateToFolder('uploads')" style="cursor: pointer; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">üìÅ</div>
                            <div style="font-weight: 600;">Uploads</div>
                            <div style="font-size: 12px; color: #666;">User uploaded files</div>
                        </div>
                        <div class="file-access-card" onclick="navigateToFolder('logs')" style="cursor: pointer; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">üìã</div>
                            <div style="font-weight: 600;">Logs</div>
                            <div style="font-size: 12px; color: #666;">Server logs & errors</div>
                        </div>
                        <div class="file-access-card" onclick="editFile('package.json')" style="cursor: pointer; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">üì¶</div>
                            <div style="font-weight: 600;">Package.json</div>
                            <div style="font-size: 12px; color: #666;">Dependencies & scripts</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="section-header">
                    <h2>Settings</h2>
                </div>

                <!-- 2FA Settings -->
                <div style="margin-bottom: 30px; padding: 24px; background: #f7fafc; border-radius: 12px;">
                    <h3 style="margin-bottom: 16px;">üîê Two-Factor Authentication (2FA)</h3>
                    <p style="margin-bottom: 16px; color: #666;">Enable 2FA for enhanced security. Use an authenticator app like Google Authenticator. <strong>Note: Make sure you are on the Settings tab.</strong></p>
                    
                    <div id="twofaStatus" style="margin-bottom: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
                    
                    <div id="twofaSetup" style="display: none;">
                        <div class="form-group">
                            <label>Secret Key</label>
                            <input type="text" id="twofaSecret" readonly style="background: #f0f0f0;">
                            <small style="color: #666;">Copy this secret and paste it into your authenticator app.</small>
                        </div>
                        
                        <div class="form-group">
                            <label>QR Code</label>
                            <div id="qrCodeContainer" style="margin: 10px 0;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Verification Code</label>
                            <input type="text" id="setupTwofaCode" placeholder="Enter 6-digit code from app" maxlength="6" pattern="\d{6}" inputmode="numeric">
                        </div>
                        
                        <button type="button" class="btn btn-success" onclick="verifyAndEnable2FA()">Verify & Enable 2FA</button>
                        <button type="button" class="btn btn-secondary" onclick="cancel2FA()">Cancel</button>
                    </div>
                    
                    <div id="twofaEnabled" style="display: none;">
                        <p style="color: #48bb78;">‚úÖ 2FA is enabled for your account.</p>
                        <button type="button" class="btn btn-danger" onclick="disable2FA()">Disable 2FA</button>
                    </div>
                    
                    <button type="button" class="btn btn-primary" id="setup2FABtn" onclick="setup2FA()">Setup 2FA</button>
                </div>

                <!-- Backup Settings -->
                <div style="margin-bottom: 30px; padding: 24px; background: #f7fafc; border-radius: 12px;">
                    <h3 style="margin-bottom: 16px;">üóÑÔ∏è Site Backup</h3>
                    <p style="margin-bottom: 16px; color: #666;">Download a password-protected ZIP backup. Use your admin login password to open/unzip it.</p>
                    <button type="button" class="btn btn-secondary" id="backupEmailBtn" onclick="downloadSiteBackup()">Download Locked Backup ZIP</button>
                    <span id="backupEmailStatus" style="margin-left: 12px; color: #666;"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productModalTitle">Add New Product</h2>
                <span class="close" onclick="closeProductModal()">&times;</span>
            </div>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label>Product Title</label>
                    <input type="text" id="productTitle" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="productCategory" required>
                        <option value="">Select Category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price ($)</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Offer Price ($) (Optional)</label>
                    <input type="number" id="productOfferPrice" step="0.01">
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="productQuantity" required>
                </div>
                <div class="form-group">
                    <label>Note/Description</label>
                    <textarea id="productNote" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Image URL</label>
                    <input type="text" id="productImage" placeholder="https://example.com/image.jpg">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Product</button>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Add User</h2>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <form onsubmit="saveUser(event)">
                <input type="hidden" id="isEditUser">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="userPassword" placeholder="Leave blank to keep current password">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="userRole" required>
                        <option value="user">User</option>
                        <option value="subscriber">Subscriber</option>
                        <option value="member">Member</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="form-group" id="editorPermissionsGroup" style="display: none;">
                    <label>Editor Widgets Access</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f7fafc;">
                        <label style="display:flex; gap:8px; align-items:center; font-weight:500; color:#333;"><input type="checkbox" class="editor-perm" value="media"> Media Library</label>
                        <label style="display:flex; gap:8px; align-items:center; font-weight:500; color:#333;"><input type="checkbox" class="editor-perm" value="products"> Add Product</label>
                        <label style="display:flex; gap:8px; align-items:center; font-weight:500; color:#333;"><input type="checkbox" class="editor-perm" value="categories"> Product Categories</label>
                        <label style="display:flex; gap:8px; align-items:center; font-weight:500; color:#333;"><input type="checkbox" class="editor-perm" value="inventory"> Inventory</label>
                        <label style="display:flex; gap:8px; align-items:center; font-weight:500; color:#333;"><input type="checkbox" class="editor-perm" value="blog"> Blog Admin</label>
                    </div>
                    <small style="color:#666; display:block; margin-top:6px;">Admin can select which widgets an Editor can use.</small>
                </div>
                <div class="form-group">
                    <label>Access Status</label>
                    <select id="userStatus">
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save User</button>
            </form>
        </div>
    </div>

    <script>
        const API = CONFIG.API;
        const AUTH_KEY = 'admin_auth_token';
        const CATEGORIES_KEY = 'product_categories';
        const REQUESTS_KEY = 'account_requests';
        const DEFAULT_CATEGORIES = ['Gmail', 'Facebook', 'Instagram', 'Twitter', 'LinkedIn', 'YouTube', 'TikTok', 'Telegram', 'WhatsApp', 'Other'];
        let lastProductsHash = ''; // For tracking dashboard inventory changes
        let cachedCategories = [];
        let notificationIntervalId = null;
        let cachedAdminAlerts = [];
        let cachedUnreadCount = 0;

        function escapeHtml(str) {
            return String(str ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatAlertTime(iso) {
            try {
                const d = new Date(iso);
                if (Number.isNaN(d.getTime())) return '';
                return d.toLocaleString();
            } catch {
                return '';
            }
        }

        function getAlertTargetUrl(alert) {
            const requestId = alert?.meta?.requestId;
            if (requestId) {
                return `notifications.html?requestId=${encodeURIComponent(String(requestId))}`;
            }
            return 'notifications.html';
        }

        function renderNotificationDropdown() {
            const countEl = document.getElementById('notificationDropdownCount');
            const listEl = document.getElementById('notificationDropdownList');
            if (!countEl || !listEl) return;

            countEl.textContent = String(cachedUnreadCount || 0);
            listEl.innerHTML = '';

            const unreadAlerts = (cachedAdminAlerts || []).filter(a => a && a.read !== true);
            const preview = unreadAlerts.slice(0, 6);

            if (preview.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'notification-dropdown-item';
                empty.style.cursor = 'default';
                empty.innerHTML = `<div class="notification-dropdown-title">No new notifications</div>`;
                listEl.appendChild(empty);
                return;
            }

            preview.forEach(alert => {
                const item = document.createElement('div');
                item.className = 'notification-dropdown-item';
                item.dataset.url = getAlertTargetUrl(alert);
                item.dataset.alertId = String(alert?.id || '');

                const title = escapeHtml(alert.title || alert.type || 'Notification');
                const message = escapeHtml(alert.message || '');
                const time = escapeHtml(formatAlertTime(alert.createdAt || alert.createdAtIso || alert.timestamp));

                item.innerHTML = `
                    <div class="notification-dropdown-title">${title}</div>
                    <div class="notification-dropdown-message">${message}</div>
                    ${time ? `<div class="notification-dropdown-time">${time}</div>` : ''}
                `;

                item.addEventListener('click', () => {
                    const url = item.dataset.url || 'notifications.html';

                    // Optimistically mark as read so it disappears from the popup list
                    // and the bell count decreases immediately.
                    const alertId = String(item.dataset.alertId || '').trim();
                    if (alertId) {
                        try {
                            cachedAdminAlerts = (cachedAdminAlerts || []).map(a =>
                                (a && String(a.id || '').trim() === alertId) ? { ...a, read: true } : a
                            );
                            if (typeof cachedUnreadCount === 'number' && cachedUnreadCount > 0) {
                                cachedUnreadCount = Math.max(0, cachedUnreadCount - 1);
                            }

                            const badge = document.getElementById('notificationBadge');
                            if (badge) {
                                if (cachedUnreadCount > 0) {
                                    badge.textContent = String(cachedUnreadCount);
                                    badge.style.display = 'flex';
                                } else {
                                    badge.style.display = 'none';
                                }
                            }
                            renderNotificationDropdown();

                            const token = localStorage.getItem(AUTH_KEY);
                            if (token) {
                                fetch(`${API}/admin/alerts/${encodeURIComponent(alertId)}/mark-read`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}` },
                                    keepalive: true
                                }).then(r => r.json().catch(() => null)).then(data => {
                                    if (data && data.success && typeof data.unreadCount === 'number') {
                                        cachedUnreadCount = data.unreadCount;
                                    }
                                }).catch(() => {});
                            }
                        } catch {}
                    }

                    window.location.href = url;
                });
                listEl.appendChild(item);
            });
        }

        function setupNotificationDropdownInteractions() {
            const wrapper = document.getElementById('notificationWrapper');
            const bell = document.getElementById('notificationBell');
            const dropdown = document.getElementById('notificationDropdown');
            if (!wrapper || !bell || !dropdown) return;

            function setOpen(open) {
                wrapper.classList.toggle('open', Boolean(open));
                bell.setAttribute('aria-expanded', open ? 'true' : 'false');
            }

            // Keep existing hover behavior, but add click-to-toggle so the list is usable on touch devices
            bell.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const isOpen = wrapper.classList.contains('open');
                setOpen(!isOpen);
            });

            bell.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    bell.click();
                }
            });

            // Clicking inside dropdown should not close it
            dropdown.addEventListener('click', (e) => e.stopPropagation());

            // Click outside closes
            document.addEventListener('click', () => setOpen(false));

            // Escape closes
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') setOpen(false);
            });
        }

        function getFilenameFromContentDisposition(cdHeader) {
            const cd = String(cdHeader || '');
            const m = cd.match(/filename\*=(?:UTF-8''|)([^;]+)|filename="?([^";]+)"?/i);
            const raw = (m && (m[1] || m[2])) ? (m[1] || m[2]) : '';
            try {
                return raw ? decodeURIComponent(raw.replace(/(^\s+|\s+$)/g, '')) : '';
            } catch {
                return raw ? raw.trim() : '';
            }
        }

        // Session timeout settings
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
        let lastActivity = Date.now();

        // Track user activity
        function resetActivity() {
            lastActivity = Date.now();
        }

        // Add event listeners for activity
        document.addEventListener('mousedown', resetActivity);
        document.addEventListener('mousemove', resetActivity);
        document.addEventListener('keypress', resetActivity);
        document.addEventListener('scroll', resetActivity);
        document.addEventListener('click', resetActivity);

        // Check for session timeout
        setInterval(() => {
            if (Date.now() - lastActivity > SESSION_TIMEOUT) {
                alert('Session expired due to inactivity. Please login again.');
                logout();
            }
        }, 60000); // Check every minute

        // Update notification count
        async function updateNotificationCount() {
            const badge = document.getElementById('notificationBadge');
            const token = localStorage.getItem(AUTH_KEY);

            // Fallback: localStorage account_requests (legacy)
            function fallbackCount() {
                try {
                    const requests = JSON.parse(localStorage.getItem(REQUESTS_KEY) || '[]');
                    return requests.filter(r => r && (r.status === 'new' || r.new === true || !r.status)).length;
                } catch {
                    return 0;
                }
            }

            if (!token) {
                badge.style.display = 'none';
                cachedAdminAlerts = [];
                cachedUnreadCount = 0;
                renderNotificationDropdown();
                return;
            }

            try {
                const resp = await fetch(`${API}/admin/alerts`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    cache: 'no-store'
                });
                const data = await resp.json().catch(() => null);
                if (resp.ok && data && data.success) {
                    cachedAdminAlerts = Array.isArray(data.alerts) ? data.alerts : [];
                    cachedUnreadCount = typeof data.unreadCount === 'number'
                        ? data.unreadCount
                        : cachedAdminAlerts.filter(a => a && a.read !== true).length;
                } else {
                    cachedAdminAlerts = [];
                    cachedUnreadCount = fallbackCount();
                }

                const count = cachedUnreadCount;

                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }

                renderNotificationDropdown();
            } catch (e) {
                const count = fallbackCount();
                cachedAdminAlerts = [];
                cachedUnreadCount = count;
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }

                renderNotificationDropdown();
            }
        }

        async function downloadSiteBackup() {
            const token = localStorage.getItem(AUTH_KEY);
            if (!token) {
                alert('No admin token found. Please login again.');
                return;
            }

            const password = prompt('Enter your admin login password to protect the ZIP backup:');
            if (!password) return;

            if (!confirm('Create and download a locked backup ZIP now?')) return;

            const btn = document.getElementById('backupEmailBtn');
            const statusEl = document.getElementById('backupEmailStatus');
            if (btn) btn.disabled = true;
            if (statusEl) statusEl.textContent = 'Preparing download...';

            try {
                let twofaCode = '';
                try {
                    const twofaResp = await fetch(`${API}/admin/2fa/status`, {
                        headers: { 'Authorization': `Bearer ${token}` },
                        cache: 'no-store'
                    });
                    const twofaData = await twofaResp.json().catch(() => null);
                    if (twofaResp.ok && twofaData && twofaData.success && twofaData.enabled === true) {
                        twofaCode = (prompt('2FA is enabled. Enter your 6-digit authenticator code:') || '').trim();
                        if (!/^\d{6}$/.test(twofaCode)) {
                            throw new Error('Valid 6-digit 2FA code required');
                        }
                    }
                } catch {
                    // If status check fails, we will rely on backend response.
                }

                const resp = await fetch(`${API}/admin/backup/download`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password, twofaCode })
                });

                if (!resp.ok) {
                    const data = await resp.json().catch(() => null);

                    if (data && data.twoFactorRequired) {
                        const retryCode = (prompt('2FA code required. Enter 6-digit code:') || '').trim();
                        if (!/^\d{6}$/.test(retryCode)) {
                            throw new Error('Valid 6-digit 2FA code required');
                        }

                        const retryResp = await fetch(`${API}/admin/backup/download`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ password, twofaCode: retryCode })
                        });

                        if (!retryResp.ok) {
                            const retryData = await retryResp.json().catch(() => null);
                            throw new Error(retryData?.message || `Request failed (${retryResp.status})`);
                        }

                        const blob = await retryResp.blob();
                        const filename = getFilenameFromContentDisposition(retryResp.headers.get('Content-Disposition')) || 'site-backup.zip';

                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);

                        if (statusEl) statusEl.textContent = 'Backup downloaded.';
                        return;
                    }

                    throw new Error(data?.message || `Request failed (${resp.status})`);
                }

                const blob = await resp.blob();
                const filename = getFilenameFromContentDisposition(resp.headers.get('Content-Disposition')) || 'site-backup.zip';

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);

                if (statusEl) statusEl.textContent = 'Backup downloaded.';
            } catch (e) {
                if (statusEl) statusEl.textContent = `Failed: ${e.message || 'Unknown error'}`;
                alert(`Backup failed: ${e.message || 'Unknown error'}`);
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        function startNotificationPolling() {
            if (notificationIntervalId) {
                clearInterval(notificationIntervalId);
            }
            notificationIntervalId = setInterval(updateNotificationCount, 30000);
        }

        function stopNotificationPolling() {
            if (notificationIntervalId) {
                clearInterval(notificationIntervalId);
                notificationIntervalId = null;
            }
        }

        window.onload = () => {
            const token = localStorage.getItem(AUTH_KEY);
            if (token) {
                // Hide login page immediately to prevent blinking
                document.getElementById('loginPage').classList.remove('show');
                document.getElementById('dashboard').style.display = 'block';
                // Load dashboard data
                loadDashboardData();
                // Update bell badge immediately and periodically
                updateNotificationCount();
                startNotificationPolling();
                setupNotificationDropdownInteractions();
                // Restore the previously active tab
                const savedTab = localStorage.getItem('activeAdminTab') || 'dashboard';
                restoreActiveTab(savedTab);
            } else {
                // Show login page
                document.getElementById('loginPage').classList.add('show');
                document.getElementById('dashboard').style.display = 'none';
            }
        };

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            const twofaCode = document.getElementById('twofaCode')?.value?.trim() || '';

            try {
                const res = await fetch(`${API}/admin-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, twofaCode })
                });
                const raw = await res.text();
                let data;
                try {
                    data = raw ? JSON.parse(raw) : {};
                } catch {
                    data = { success: false, message: raw || `Request failed (${res.status})` };
                }

                if (res.status === 429 && !data.success) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = data.message || 'Too many login attempts. Please try again later.';
                    return;
                }

                if (data.success) {
                    // Check access status before allowing login
                    const accessStatus = data.user?.status || 'active';
                    if (accessStatus !== 'active') {
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = `Your account access has been ${accessStatus === 'suspended' ? 'suspended' : 'disabled'}. Contact the administrator.`;
                        return;
                    }
                    
                    localStorage.setItem(AUTH_KEY, data.token);
                    localStorage.setItem('adminLoggedIn', 'true');
                    localStorage.setItem('adminToken', data.token);
                    localStorage.setItem('admin_user', data.user.username);
                    errorDiv.style.display = 'none';

                    // Editors should go to the Website Dashboard (limited access)
                    if (String(data.user?.role || '').toLowerCase() === 'editor') {
                        window.location.href = 'dashboard.html';
                        return;
                    }

                    showDashboard();
                } else {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = data.message || 'Invalid credentials';
                    if (data && data.twoFactorRequired) {
                        document.getElementById('twofaGroup').style.display = 'block';
                    }
                }
            } catch (err) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Unable to connect to server. Please check if backend is running.';
            }
        }

        function showDashboard() {
            // Show the dashboard within admin.html instead of redirecting
            document.getElementById('loginPage').classList.remove('show');
            document.getElementById('dashboard').style.display = 'block';
            // Load dashboard data
            loadDashboardData();
            // Update bell badge immediately and periodically
            updateNotificationCount();
            startNotificationPolling();
            // Restore the previously active tab
            const savedTab = localStorage.getItem('activeAdminTab') || 'dashboard';
            restoreActiveTab(savedTab);
        }

        function loadDashboardData() {
            // Load initial dashboard data
            loadCategories();
            loadProducts();
            loadUsers();
            loadNews();
            check2FAStatus();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                stopNotificationPolling();
                // Clear all admin authentication data
                localStorage.removeItem(AUTH_KEY);
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminToken');
                // Show login page instead of reloading
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('loginPage').classList.add('show');
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('twofaCode').value = '';
                document.getElementById('loginError').style.display = 'none';
                document.getElementById('twofaGroup').style.display = 'none';
            }
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(name + 'Tab').classList.add('active');
            
            // Save the active tab to localStorage
            localStorage.setItem('activeAdminTab', name);

            if (name === 'products') loadProducts();
            else if (name === 'categories') loadCategories();
            else if (name === 'users') loadUsers();
            else if (name === 'news') loadNews();
            else if (name === 'settings') {}
        }
        
        function restoreActiveTab(tabName) {
            const tabElement = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (tabElement) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                tabElement.classList.add('active');
                const contentElement = document.getElementById(tabName + 'Tab');
                if (contentElement) {
                    contentElement.classList.add('active');
                }
                // Load data for the tab
                if (tabName === 'products') loadProducts();
                else if (tabName === 'categories') loadCategories();
                else if (tabName === 'users') loadUsers();
                else if (tabName === 'news') loadNews();
            }
        }

        // ========== PRODUCTS ==========
        async function loadProducts() {
            try {
                const res = await fetch(`${API}/products`);
                const data = await res.json();
                if (data.success) {
                    // Update hash for change detection
                    lastProductsHash = JSON.stringify(data.products);

                    const tbody = document.getElementById('productsTable');
                    tbody.innerHTML = data.products.map(p => {
                        const priceDisplay = p.offerPrice
                            ? `<span style="text-decoration: line-through; color: #a0aec0;">$${p.price.toFixed(2)}</span> <span style="color: #48bb78; font-weight: 600;">$${p.offerPrice.toFixed(2)}</span>`
                            : `$${p.price.toFixed(2)}`;
                        const status = p.quantity > 0
                            ? '<span class="status-badge status-in-stock">In Stock</span>'
                            : '<span class="status-badge status-out">Out of Stock</span>';

                        return `
                    <tr>
                        <td style="font-weight: 500;">${p.title}</td>
                        <td>${p.category || 'N/A'}</td>
                        <td>${priceDisplay}</td>
                        <td>${p.quantity}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;" onclick='editProduct(${JSON.stringify(p).replace(/'/g, "&apos;")})'>Edit</button>
                            <button class="btn btn-danger" style="padding: 8px 16px; font-size: 12px;" onclick="deleteProduct('${p.id}')">Delete</button>
                        </td>
                    </tr>
                `;
                    }).join('');
                }
            } catch (err) {
                console.error('Error loading products:', err);
            }
        }

        function openProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('productId').value = '';
            document.getElementById('productTitle').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productOfferPrice').value = '';
            document.getElementById('productQuantity').value = '';
            document.getElementById('productNote').value = '';
            document.getElementById('productImage').value = '';
            populateCategoryDropdown();
            document.getElementById('productModal').style.display = 'block';
        }

        function editProduct(product) {
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productTitle').value = product.title;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productOfferPrice').value = product.offerPrice || '';
            document.getElementById('productQuantity').value = product.quantity;
            document.getElementById('productNote').value = product.note || '';
            document.getElementById('productImage').value = product.image || '';
            populateCategoryDropdown(product.category);
            document.getElementById('productModal').style.display = 'block';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const product = {
                id: id || Date.now().toString(),
                title: document.getElementById('productTitle').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                offerPrice: document.getElementById('productOfferPrice').value ? parseFloat(document.getElementById('productOfferPrice').value) : null,
                quantity: parseInt(document.getElementById('productQuantity').value),
                note: document.getElementById('productNote').value,
                image: document.getElementById('productImage').value
            };

            const url = id ? `${API}/products/${id}` : `${API}/products`;
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(product)
                });
                const data = await res.json();
                if (data.success) {
                    closeProductModal();
                    loadProducts();
                    alert(id ? 'Product updated successfully!' : 'Product added successfully!');
                }
            } catch (err) {
                alert('Failed to save product.');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            try {
                const res = await fetch(`${API}/products/${encodeURIComponent(String(id))}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}` }
                });
                const raw = await res.text();
                let data;
                try {
                    data = raw ? JSON.parse(raw) : {};
                } catch {
                    data = { success: false, message: raw || `Request failed (${res.status})` };
                }

                if (!res.ok || !data.success) {
                    alert(data.message || 'Failed to delete product');
                    return;
                }

                // If backend returned updated products list, refresh from API anyway (authoritative)
                loadProducts();
                alert('Product deleted!');
            } catch (err) {
                alert('Failed to delete product');
            }
        }

        // Periodic sync with dashboard inventory changes
        setInterval(async () => {
            try {
                const res = await fetch(`${API}/products`);
                const data = await res.json();
                if (data.success && Array.isArray(data.products)) {
                    const currentHash = JSON.stringify(data.products);
                    if (currentHash !== lastProductsHash && lastProductsHash !== '') {
                        console.log('Products updated from dashboard inventory, refreshing admin panel...');
                        loadProducts(); // Refresh the products table
                        // Show notification
                        alert('Product quantities updated from dashboard inventory!');
                    }
                    lastProductsHash = currentHash;
                }
            } catch (error) {
                console.warn('Failed to check for dashboard inventory updates:', error);
            }
        }, 15 * 1000); // Check every 15 seconds

        // ========== USERS ==========
        async function loadUsers() {
            try {
                const res = await fetch(`${API}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}` }
                });
                const data = await res.json();
                if (data.success) {
                    const currentAdmin = localStorage.getItem('admin_user') || 'admin';
                    document.getElementById('usersTable').innerHTML = data.users.map(u => {
                        const isCurrentAdmin = currentAdmin === u.username && u.role === 'admin';
                        const statusColor = u.status === 'active' ? '#48bb78' : u.status === 'suspended' ? '#ed8936' : '#f56565';
                        return `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.email}</td>
                    <td><span class="status-badge" style="background: #ebf4ff; color: #2c5282;">${u.role}</span></td>
                    <td><span class="status-badge" style="background: ${statusColor}33; color: ${statusColor};">${u.status || 'active'}</span></td>
                    <td>${u.lastLogin ? new Date(u.lastLogin).toLocaleString() : 'Never'}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;" onclick='editUser(${JSON.stringify(u).replace(/'/g, "&apos;")})'>Edit</button>
                        ${u.role === 'admin' && !isCurrentAdmin ? `<button class="btn btn-warning" style="padding: 8px 16px; font-size: 12px;" onclick="revokeAdminAccess('${u.username}')">Revoke Admin</button>` : ''}
                        ${u.status !== 'active' ? `<button class="btn btn-success" style="padding: 8px 16px; font-size: 12px;" onclick="restoreAccess('${u.username}')">Restore</button>` : ''}
                        <button class="btn btn-danger" style="padding: 8px 16px; font-size: 12px;" onclick="deleteUser('${u.username}')">Delete</button>
                    </td>
                </tr>
            `;
                    }).join('');
                }
            } catch (err) {
                console.error('Error loading users:', err);
            }
        }

        async function revokeAdminAccess(username) {
            if (!confirm(`Are you sure you want to revoke admin access from "${username}"? They will be demoted to 'user' role.`)) return;
            try {
                const res = await fetch(`${API}/admin/users/${username}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: 'user', status: 'active' })
                });
                const data = await res.json();
                if (data.success) {
                    loadUsers();
                    alert('Admin access revoked successfully!');
                } else {
                    alert(data.message || 'Failed to revoke admin access');
                }
            } catch (err) {
                alert('Error revoking admin access');
            }
        }

        async function restoreAccess(username) {
            if (!confirm(`Are you sure you want to restore access for "${username}"?`)) return;
            try {
                const res = await fetch(`${API}/admin/users/${username}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'active' })
                });
                const data = await res.json();
                if (data.success) {
                    loadUsers();
                    alert('Access restored successfully!');
                } else {
                    alert(data.message || 'Failed to restore access');
                }
            } catch (err) {
                alert('Error restoring access');
            }
        }

        function openUserModal() {
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('isEditUser').value = 'false';
            document.getElementById('userUsername').value = '';
            document.getElementById('userUsername').disabled = false;
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = 'user';
            document.getElementById('userStatus').value = 'active';
            setEditorPermissionsUI('user', ['media', 'products', 'categories', 'inventory', 'blog']);
            document.getElementById('userModal').style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function editUser(user) {
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('isEditUser').value = 'true';
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userUsername').disabled = true;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userStatus').value = user.status || 'active';
            setEditorPermissionsUI(user.role, user.permissions || []);
            document.getElementById('userModal').style.display = 'block';
        }

        function setEditorPermissionsUI(role, permissions) {
            const group = document.getElementById('editorPermissionsGroup');
            const isEditor = String(role || '').toLowerCase() === 'editor';
            if (group) group.style.display = isEditor ? 'block' : 'none';

            const perms = Array.isArray(permissions) ? permissions.map(p => String(p || '').trim()) : [];
            document.querySelectorAll('.editor-perm').forEach(cb => {
                cb.checked = isEditor ? perms.includes(cb.value) : false;
            });
        }

        // Show/hide editor permissions when role changes
        document.addEventListener('DOMContentLoaded', () => {
            const roleSelect = document.getElementById('userRole');
            if (roleSelect) {
                roleSelect.addEventListener('change', () => {
                    const role = roleSelect.value;
                    if (String(role).toLowerCase() === 'editor') {
                        // default: all widget perms enabled
                        setEditorPermissionsUI(role, ['media', 'products', 'categories', 'inventory', 'blog']);
                    } else {
                        setEditorPermissionsUI(role, []);
                    }
                });
            }
        });

        async function saveUser(e) {
            e.preventDefault();
            
            const isEdit = document.getElementById('isEditUser').value === 'true';
            const username = document.getElementById('userUsername').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;

            let permissions = [];
            if (String(role).toLowerCase() === 'editor') {
                permissions = Array.from(document.querySelectorAll('.editor-perm'))
                    .filter(cb => cb && cb.checked)
                    .map(cb => cb.value);
            }

            console.log('=== SAVE USER DEBUG ===');
            console.log('isEdit:', isEdit);
            console.log('isEditUser value:', document.getElementById('isEditUser').value);
            console.log('username:', username);
            console.log('email:', email);
            console.log('role:', role);
            console.log('status:', status);

            // Validation
            if (!username || !email) {
                alert('Username and email are required');
                return;
            }

            if (!isEdit && !password) {
                alert('Password is required for new users');
                return;
            }

            const userData = { username, email, role, status };
            if (password) userData.password = password;
            if (String(role).toLowerCase() === 'editor') userData.permissions = permissions;

            const url = isEdit ? `${API}/admin/users/${username}` : `${API}/admin/users`;
            const method = isEdit ? 'PUT' : 'POST';

            console.log('Method:', method);
            console.log('URL:', url);
            console.log('Data:', userData);

            try {
                const res = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                const data = await res.json();
                console.log('Response:', data);
                
                if (data.success) {
                    closeUserModal();
                    loadUsers();
                    alert(isEdit ? 'User updated successfully!' : 'User created successfully!');
                } else {
                    alert(data.message || 'Failed to save user');
                }
            } catch (err) {
                alert('Error saving user');
                console.error('Error:', err);
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?`)) return;
            try {
                const res = await fetch(`${API}/admin/users/${username}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}` }
                });
                const data = await res.json();
                if (data.success) {
                    loadUsers();
                    alert('User deleted successfully!');
                } else {
                    alert(data.message || 'Failed to delete user');
                }
            } catch (err) {
                alert('Error deleting user');
            }
        }

        // ========== NEWS ==========
        function loadNews() {
            const news = JSON.parse(localStorage.getItem('newsUpdates') || '[]');
            const newsList = document.getElementById('newsList');
            if (news.length === 0) {
                newsList.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 40px;">No news items yet.</p>';
            } else {
                newsList.innerHTML = news.map((n, i) => `
            <div class="news-item">
                <div class="news-content">
                    <span class="news-date">${n.date}</span>
                    <span>${n.content}</span>
                </div>
                <div class="news-actions">
                    <button class="btn btn-edit" onclick="editNews(${i})">Edit</button>
                    <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteNews(${i})">Delete</button>
                </div>
            </div>
        `).join('');
            }
        }

        function addNews(e) {
            e.preventDefault();
            const news = JSON.parse(localStorage.getItem('newsUpdates') || '[]');
            const editIndex = parseInt(document.getElementById('newsEditIndex').value);
            const newsItem = {
                date: document.getElementById('newsDate').value,
                content: document.getElementById('newsContent').value
            };

            if (editIndex >= 0) {
                news[editIndex] = newsItem;
            } else {
                news.unshift(newsItem);
            }

            localStorage.setItem('newsUpdates', JSON.stringify(news));
            document.getElementById('newsContent').value = '';
            document.getElementById('newsEditIndex').value = '-1';
            document.getElementById('newsFormTitle').textContent = 'Add News/Update';
            document.getElementById('newsSubmitBtn').textContent = 'Add News';
            document.getElementById('newsCancelBtn').style.display = 'none';
            loadNews();
            alert(editIndex >= 0 ? 'News updated!' : 'News added!');
        }

        function editNews(index) {
            const news = JSON.parse(localStorage.getItem('newsUpdates') || '[]');
            const item = news[index];
            document.getElementById('newsDate').value = item.date;
            document.getElementById('newsContent').value = item.content;
            document.getElementById('newsEditIndex').value = index;
            document.getElementById('newsFormTitle').textContent = 'Edit News/Update';
            document.getElementById('newsSubmitBtn').textContent = 'Update News';
            document.getElementById('newsCancelBtn').style.display = 'inline-block';
        }

        function cancelNewsEdit() {
            document.getElementById('newsContent').value = '';
            document.getElementById('newsEditIndex').value = '-1';
            document.getElementById('newsFormTitle').textContent = 'Add News/Update';
            document.getElementById('newsSubmitBtn').textContent = 'Add News';
            document.getElementById('newsCancelBtn').style.display = 'none';
        }

        function deleteNews(index) {
            if (!confirm('Delete this news item?')) return;
            const news = JSON.parse(localStorage.getItem('newsUpdates') || '[]');
            news.splice(index, 1);
            localStorage.setItem('newsUpdates', JSON.stringify(news));
            loadNews();
        }

        // ========== CATEGORIES ==========
        async function fetchCategoriesFromServer() {
            try {
                const res = await fetch(`${API}/categories`, { cache: 'no-store' });
                const data = await res.json();
                if (data && data.success && Array.isArray(data.categories)) {
                    return data.categories;
                }
            } catch (e) {
                console.warn('Failed to fetch categories from server, using fallback.', e);
            }

            // Fallback (legacy): localStorage categories or defaults
            try {
                return JSON.parse(localStorage.getItem(CATEGORIES_KEY) || JSON.stringify(DEFAULT_CATEGORIES));
            } catch {
                return [...DEFAULT_CATEGORIES];
            }
        }

        async function loadCategories() {
            const cats = await fetchCategoriesFromServer();
            cachedCategories = Array.isArray(cats) ? cats : [];

            document.getElementById('categoriesList').innerHTML = cachedCategories.map(c => {
                const safeLabel = String(c);
                return `\n        <span class="category-tag">${safeLabel} <button onclick='deleteCategory(${JSON.stringify(String(c))})'>&times;</button></span>`;
            }).join('');

            populateCategoryDropdown();
        }

        async function populateCategoryDropdown(selectedCategory = '') {
            if (!Array.isArray(cachedCategories) || cachedCategories.length === 0) {
                cachedCategories = await fetchCategoriesFromServer();
            }

            const select = document.getElementById('productCategory');
            const selectedLower = String(selectedCategory || '').toLowerCase();

            select.innerHTML = '<option value="">Select Category</option>' +
                cachedCategories.map(c => {
                    const value = String(c);
                    const isSelected = value.toLowerCase() === selectedLower;
                    return `<option value="${value}" ${isSelected ? 'selected' : ''}>${value}</option>`;
                }).join('');
        }

        async function addCategory(e) {
            e.preventDefault();
            const name = document.getElementById('newCategory').value.trim();
            if (!name) return alert('Please enter a category name');

            try {
                const res = await fetch(`${API}/categories`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                const raw = await res.text();
                let data;
                try {
                    data = raw ? JSON.parse(raw) : {};
                } catch {
                    data = { success: false, message: raw || `Request failed (${res.status})` };
                }

                if (!res.ok || !data.success) {
                    return alert(data.message || 'Failed to add category');
                }

                document.getElementById('newCategory').value = '';
                await loadCategories();
                alert('Category added successfully!');
            } catch (err) {
                console.error('Error adding category:', err);
                alert('Failed to add category');
            }
        }

        async function deleteCategory(name) {
            if (!confirm(`Delete category "${name}"?`)) return;

            try {
                const current = Array.isArray(cachedCategories) ? cachedCategories : await fetchCategoriesFromServer();
                if (current.length <= 1) return alert('Cannot delete the last category!');

                const res = await fetch(`${API}/categories/${encodeURIComponent(name)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}`
                    }
                });

                const raw = await res.text();
                let data;
                try {
                    data = raw ? JSON.parse(raw) : {};
                } catch {
                    data = { success: false, message: raw || `Request failed (${res.status})` };
                }

                if (!res.ok || !data.success) {
                    return alert(data.message || 'Failed to delete category');
                }

                await loadCategories();
                alert('Category deleted successfully!');
            } catch (err) {
                console.error('Error deleting category:', err);
                alert('Failed to delete category');
            }
        }

        // ========== 2FA FUNCTIONS ==========
        function generateTOTPSecret() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            try {
                if (crypto && crypto.getRandomValues) {
                    const bytes = new Uint8Array(32);
                    crypto.getRandomValues(bytes);
                    for (let i = 0; i < 32; i++) {
                        secret += chars.charAt(bytes[i] % chars.length);
                    }
                    return secret;
                }
            } catch {}

            for (let i = 0; i < 32; i++) {
                secret += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return secret;
        }

        function base32Decode(encoded) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let bits = '';
            for (let char of encoded.toUpperCase()) {
                const index = alphabet.indexOf(char);
                if (index === -1) continue;
                bits += index.toString(2).padStart(5, '0');
            }
            let bytes = [];
            for (let i = 0; i < bits.length; i += 8) {
                const byte = bits.substr(i, 8);
                if (byte.length === 8) {
                    bytes.push(parseInt(byte, 2));
                }
            }
            return bytes;
        }

        function generateTOTP(secret, timeStep = 30) {
            const time = Math.floor(Date.now() / 1000 / timeStep);
            const timeHex = time.toString(16).padStart(16, '0');
            
            const keyBytes = base32Decode(secret);
            const keyHex = keyBytes.map(b => b.toString(16).padStart(2, '0')).join('');
            
            const hmac = new jsSHA('SHA-1', 'HEX');
            hmac.setHMACKey(keyHex, 'HEX');
            hmac.update(timeHex);
            const hmacResult = hmac.getHMAC('HEX');
            
            // Get offset from last byte
            const offset = parseInt(hmacResult.substr(38, 2), 16) & 0xf;
            
            // Get 4 bytes starting from offset
            const binCode = parseInt(hmacResult.substr(offset * 2, 8), 16);
            
            // Mask and mod
            const code = (binCode & 0x7fffffff) % 1000000;
            return code.toString().padStart(6, '0');
        }

        function setup2FA() {
            try {
                const secret = generateTOTPSecret();
                document.getElementById('twofaSecret').value = secret;
                
                // Generate QR Code
                const qrText = `otpauth://totp/BuyPvaAccount:admin?secret=${secret}&issuer=BuyPvaAccount`;
                document.getElementById('qrCodeContainer').innerHTML = '';
                if (typeof QRCode !== 'undefined') {
                    new QRCode(document.getElementById('qrCodeContainer'), {
                        text: qrText,
                        width: 128,
                        height: 128
                    });
                } else {
                    document.getElementById('qrCodeContainer').innerHTML = '<p>QR Code library not loaded. Use secret manually.</p>';
                }
                
                document.getElementById('twofaSetup').style.display = 'block';
                document.getElementById('setup2FABtn').style.display = 'none';
                console.log('2FA setup initiated');
            } catch (error) {
                console.error('Error setting up 2FA:', error);
                alert('Error setting up 2FA: ' + error.message);
            }
        }

        async function verifyAndEnable2FA() {
            const token = localStorage.getItem(AUTH_KEY);
            if (!token) {
                show2FAStatus('Please login first.', 'error');
                return;
            }

            const secret = document.getElementById('twofaSecret').value;
            const code = document.getElementById('setupTwofaCode').value.trim();

            if (!/^\d{6}$/.test(code)) {
                show2FAStatus('Please enter a valid 6-digit code.', 'error');
                return;
            }

            try {
                const resp = await fetch(`${API}/admin/2fa/enable`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ secret, code })
                });

                const data = await resp.json().catch(() => null);
                if (!resp.ok || !data || data.success !== true) {
                    throw new Error(data?.message || `Request failed (${resp.status})`);
                }

                // Keep local flags in sync for UI.
                localStorage.setItem('admin_2fa_enabled', 'true');
                localStorage.setItem('admin_2fa_secret', secret);

                show2FAStatus('2FA enabled successfully!', 'success');
                document.getElementById('twofaSetup').style.display = 'none';
                document.getElementById('twofaEnabled').style.display = 'block';
                document.getElementById('setup2FABtn').style.display = 'none';
                document.getElementById('twofaGroup').style.display = 'block';
            } catch (e) {
                show2FAStatus(e.message || 'Failed to enable 2FA', 'error');
            }
        }

        async function disable2FA() {
            if (!confirm('Are you sure you want to disable 2FA? This will make your account less secure.')) return;

            const token = localStorage.getItem(AUTH_KEY);
            if (!token) {
                show2FAStatus('Please login first.', 'error');
                return;
            }

            try {
                const resp = await fetch(`${API}/admin/2fa/disable`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await resp.json().catch(() => null);
                if (!resp.ok || !data || data.success !== true) {
                    throw new Error(data?.message || `Request failed (${resp.status})`);
                }

                localStorage.removeItem('admin_2fa_secret');
                localStorage.setItem('admin_2fa_enabled', 'false');

                document.getElementById('twofaEnabled').style.display = 'none';
                document.getElementById('setup2FABtn').style.display = 'block';
                show2FAStatus('2FA disabled.', 'info');
            } catch (e) {
                show2FAStatus(e.message || 'Failed to disable 2FA', 'error');
            }
        }

        function show2FAStatus(message, type) {
            const status = document.getElementById('twofaStatus');
            status.textContent = message;
            status.style.display = 'block';
            status.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
            status.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Check 2FA status on load
        async function check2FAStatus() {
            const token = localStorage.getItem(AUTH_KEY);
            let enabled = localStorage.getItem('admin_2fa_enabled') === 'true';

            if (token) {
                try {
                    const resp = await fetch(`${API}/admin/2fa/status`, {
                        headers: { 'Authorization': `Bearer ${token}` },
                        cache: 'no-store'
                    });
                    const data = await resp.json().catch(() => null);
                    if (resp.ok && data && data.success) {
                        enabled = data.enabled === true;
                        localStorage.setItem('admin_2fa_enabled', enabled ? 'true' : 'false');
                    }
                } catch {}
            }

            if (enabled) {
                document.getElementById('twofaEnabled').style.display = 'block';
                document.getElementById('setup2FABtn').style.display = 'none';
                document.getElementById('twofaGroup').style.display = 'block';
            } else {
                document.getElementById('twofaEnabled').style.display = 'none';
                document.getElementById('setup2FABtn').style.display = 'block';
            }
        }

        // Call on page load
        check2FAStatus();

        // File Manager Functions
        function openFileManager() {
            window.open('dashboard.html', '_blank');
        }

        function navigateToFolder(folder) {
            // This would open the full file manager and navigate to the folder
            window.open(`dashboard.html#${folder}`, '_blank');
        }

        function editFile(filename) {
            // This would open the file in the dashboard editor
            window.open(`dashboard.html?edit=${filename}`, '_blank');
        }
    </script>
</body>

</html>
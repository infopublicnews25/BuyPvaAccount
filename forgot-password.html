<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - BuyPvaAccount</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 450px; width: 100%; padding: 40px; }
        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px; }
        input { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-bottom: 10px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .message { padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none; font-size: 14px; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; display: block; }
        .links { text-align: center; margin-top: 20px; font-size: 14px; }
        .links a { color: #667eea; text-decoration: none; font-weight: 500; }
        .links a:hover { text-decoration: underline; }
        .step { display: none; }
        .step.active { display: block; }
        .info-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reset Password</h1>
        <p class="subtitle">Recover access to your account</p>
        <div id="message" class="message"></div>
        <div id="step1" class="step active">
            <div class="info-box">Enter your email address and we''ll send you a verification code to reset your password.</div>
            <form id="emailForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" required placeholder="your.email@example.com">
                </div>
                <button type="submit" class="btn btn-primary">Send Verification Code</button>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='login.html'">Back to Login</button>
            </form>
        </div>
        <div id="step2" class="step">
            <div class="info-box">A verification code has been sent to <strong id="maskedEmail"></strong>. Please check your email and enter the code below.</div>
            <form id="verifyForm">
                <div class="form-group">
                    <label for="verificationCode">Verification Code</label>
                    <input type="text" id="verificationCode" required placeholder="Enter 6-digit code" maxlength="6">
                    <small style="display: block; margin-top: 5px; color: #666;">Code expires in <span id="timeRemaining">10:00</span></small>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Verify Code</button>
                    <button type="button" class="btn btn-secondary" onclick="resendCode()" id="resendBtn" style="flex: 1;">Resend Code</button>
                </div>
                <div style="text-align: center; font-size: 12px; color: #666; margin-bottom: 10px;">
                    Attempts remaining: <span id="attemptsRemaining">3</span>
                </div>
                <button type="button" class="btn btn-secondary" onclick="goToStep(1)" style="width: 100%;">Back</button>
            </form>
        </div>
        <div id="step3" class="step">
            <div class="info-box">Create a new strong password for your account.</div>
            <form id="resetForm">
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" required placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Confirm New Password</label>
                    <input type="password" id="confirmNewPassword" required placeholder="Re-enter new password">
                </div>
                <button type="submit" class="btn btn-primary">Reset Password</button>
            </form>
        </div>
        <div class="links">Remember your password? <a href="login.html">Login here</a></div>
    </div>
    <script>
        let currentEmail = "";
        let verificationCode = "";
        let codeExpirationTime = null;
        let countdownInterval = null;
        let attemptsRemaining = 3;
        const BACKEND_URL = 'http://localhost:3000'; // Change this to your backend URL

        document.getElementById("emailForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const email = document.getElementById("email").value.trim().toLowerCase();
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            try {
                const users = JSON.parse(localStorage.getItem("users") || "[]");
                const user = users.find(u => u.email === email);
                if (!user) {
                    showMessage("No account found with this email address.", "error");
                    return;
                }
                
                // Disable button and show loading
                submitButton.disabled = true;
                submitButton.textContent = 'Sending...';
                
                // Generate secure verification code
                verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
                currentEmail = email;
                
                // Set expiration time (10 minutes from now)
                codeExpirationTime = Date.now() + (10 * 60 * 1000);
                attemptsRemaining = 3;
                
                // Mask email for display (e.g., u***@gmail.com)
                const maskedEmail = maskEmail(email);
                document.getElementById("maskedEmail").textContent = maskedEmail;
                document.getElementById("attemptsRemaining").textContent = attemptsRemaining;
                
                // Send email via backend API
                try {
                    const response = await fetch(`${BACKEND_URL}/api/send-reset-code`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            code: verificationCode
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showMessage("Verification code sent to your email! Please check your inbox.", "success");
                        setTimeout(() => { 
                            goToStep(2); 
                            startCountdown();
                        }, 2000);
                    } else {
                        throw new Error(result.message || 'Failed to send email');
                    }
                } catch (emailError) {
                    console.error("Email sending error:", emailError);
                    // Fallback: Show code in console for testing
                    console.log("🔐 VERIFICATION CODE (FALLBACK): " + verificationCode);
                    showMessage("⚠️ Email service unavailable. Code logged to console (F12) for testing.", "error");
                    setTimeout(() => { 
                        goToStep(2); 
                        startCountdown();
                    }, 3000);
                }
            } catch (error) {
                console.error("Error:", error);
                showMessage("An error occurred. Please try again.", "error");
            } finally {
                // Re-enable button
                submitButton.disabled = false;
                submitButton.textContent = 'Send Verification Code';
            }
        });

        document.getElementById("verifyForm").addEventListener("submit", function(e) {
            e.preventDefault();
            
            // Check if code has expired
            if (Date.now() > codeExpirationTime) {
                showMessage("Verification code has expired. Please request a new code.", "error");
                document.getElementById("resendBtn").focus();
                return;
            }
            
            // Check attempts remaining
            if (attemptsRemaining <= 0) {
                showMessage("Too many failed attempts. Please request a new code.", "error");
                document.getElementById("resendBtn").focus();
                return;
            }
            
            const enteredCode = document.getElementById("verificationCode").value.trim();
            if (enteredCode === verificationCode) {
                clearInterval(countdownInterval);
                showMessage("Code verified successfully!", "success");
                setTimeout(() => { goToStep(3); }, 1500);
            } else {
                attemptsRemaining--;
                document.getElementById("attemptsRemaining").textContent = attemptsRemaining;
                
                if (attemptsRemaining > 0) {
                    showMessage(`Invalid verification code. ${attemptsRemaining} attempt(s) remaining.`, "error");
                } else {
                    showMessage("Too many failed attempts. Please request a new code.", "error");
                }
                document.getElementById("verificationCode").value = "";
            }
        });
        document.getElementById("resetForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword = document.getElementById("confirmNewPassword").value;
            if (newPassword.length < 6) {
                showMessage("Password must be at least 6 characters long.", "error");
                return;
            }
            if (newPassword !== confirmPassword) {
                showMessage("Passwords do not match.", "error");
                return;
            }
            try {
                const users = JSON.parse(localStorage.getItem("users") || "[]");
                const userIndex = users.findIndex(u => u.email === currentEmail);
                if (userIndex === -1) {
                    showMessage("User not found.", "error");
                    return;
                }
                users[userIndex].password = btoa(newPassword);
                localStorage.setItem("users", JSON.stringify(users));
                
                // Clear sensitive data
                verificationCode = "";
                currentEmail = "";
                codeExpirationTime = null;
                clearInterval(countdownInterval);
                
                showMessage("Password reset successful! Redirecting to login...", "success");
                setTimeout(() => { window.location.href = "login.html"; }, 2000);
            } catch (error) {
                console.error("Error:", error);
                showMessage("An error occurred. Please try again.", "error");
            }
        });

        async function resendCode() {
            const resendBtn = document.getElementById("resendBtn");
            
            // Disable button and show loading
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';
            
            // Generate new code
            verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Reset expiration time
            codeExpirationTime = Date.now() + (10 * 60 * 1000);
            attemptsRemaining = 3;
            document.getElementById("attemptsRemaining").textContent = attemptsRemaining;
            document.getElementById("verificationCode").value = "";
            
            // Restart countdown
            clearInterval(countdownInterval);
            startCountdown();
            
            // Send email via backend API
            try {
                const response = await fetch(`${BACKEND_URL}/api/send-reset-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: currentEmail,
                        code: verificationCode
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage("New verification code sent to your email!", "success");
                } else {
                    throw new Error(result.message || 'Failed to send email');
                }
            } catch (emailError) {
                console.error("Email sending error:", emailError);
                // Fallback: Show code in console
                console.log("🔐 NEW VERIFICATION CODE (FALLBACK): " + verificationCode);
                showMessage("⚠️ Email service unavailable. Code logged to console (F12).", "error");
            } finally {
                // Re-enable button
                resendBtn.disabled = false;
                resendBtn.textContent = 'Resend Code';
            }
        }

        function startCountdown() {
            clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                const timeLeft = codeExpirationTime - Date.now();
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById("timeRemaining").textContent = "Expired";
                    document.getElementById("timeRemaining").style.color = "red";
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                document.getElementById("timeRemaining").textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function maskEmail(email) {
            const [localPart, domain] = email.split('@');
            if (localPart.length <= 2) {
                return localPart[0] + '***@' + domain;
            }
            return localPart[0] + '***' + localPart[localPart.length - 1] + '@' + domain;
        }

        function goToStep(stepNumber) {
            document.querySelectorAll(".step").forEach(step => { step.classList.remove("active"); });
            document.getElementById("step" + stepNumber).classList.add("active");
            document.getElementById("message").style.display = "none";
            
            // Clear countdown when going back to step 1
            if (stepNumber === 1) {
                clearInterval(countdownInterval);
                verificationCode = "";
                currentEmail = "";
                codeExpirationTime = null;
                attemptsRemaining = 3;
            }
        }
        
        function showMessage(text, type) {
            const messageDiv = document.getElementById("message");
            messageDiv.textContent = text;
            messageDiv.className = "message " + type;
            messageDiv.style.display = "block";
            if (type === "error") {
                setTimeout(() => { messageDiv.style.display = "none"; }, 5000);
            }
        }
    </script>
    </script>
</body>
</html>

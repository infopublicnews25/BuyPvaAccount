<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Checkout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="config.js"></script>
  <script src="language-utils.js"></script>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--line:#e5e7eb;--text:#111827;--muted:#6b7280;--ok:#16a34a;--danger:#ef4444;--primary:#2563eb}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Segoe UI, Tahoma, Arial, sans-serif}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .header h1{margin:0;font-size:22px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.ok{background:var(--ok);color:#fff;border-color:transparent}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px}
    .section{padding:16px}
    .title{font-weight:800;margin-bottom:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:780px){.row{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{min-height:40px;display:block}
    .field input,.field select,.field textarea{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
    .muted{color:var(--muted);font-size:13px}
    .summary .item{display:grid;grid-template-columns:1fr 80px 80px;gap:10px;padding:10px 0;border-top:1px dashed var(--line);align-items:center}
    .summary .item:first-child{border-top:0}
    .summary .totals{padding-top:10px;border-top:1px solid var(--line)}
    .summary .row{display:flex;justify-content:space-between;margin:6px 0}
    .summary .row.total{font-weight:800}
    .pm-box{border:1px solid var(--line);border-radius:12px;padding:12px}
    .pm-option{display:flex;align-items:center;gap:8px;margin:8px 0}
    .terms{display:flex;gap:10px;align-items:flex-start}
    .terms a{color:var(--primary);text-decoration:underline}
  </style>
</head>
<body>
  <section id="checkout" class="checkout-page" aria-label="Checkout">
    <div class="container">
      <div class="header">
        <h1 id="checkout-headline">You are almost there</h1>
        <div class="actions">
          <a class="btn" id="checkout-back-cart" href="Cartpage.html">‚Üê Back to cart</a>
          <a class="btn" id="checkout-continue-marketplace" href="marketplace.html">Continue shopping</a>
        </div>
      </div>

      <div class="grid">
        <!-- Billing -->
        <div class="card">
          <div class="section">
            <div class="title" id="billing-title">Billing details</div>
            <div class="row">
              <div class="field"><label for="b-first">First name *</label><input id="b-first" required></div>
              <div class="field"><label for="b-last">Last name *</label><input id="b-last" required></div>
            </div>
            <div class="row">
              <div class="field"><label for="b-phone">Phone</label><input id="b-phone" placeholder="+8801xxxxxxxxx"></div>
              <div class="field"><label for="b-email">Email address *</label><input id="b-email" type="email" required></div>
            </div>
            <div class="row">
              <div class="field"><label for="b-extra">Additional Contact (WhatsApp, Telegram, Skype, Other)</label><input id="b-extra" placeholder="@telegram"></div>
              <div class="field"><label for="b-country">Country / Region</label>
                <select id="b-country"></select>
              </div>
            </div>
            <div class="field"><label for="b-notes">Additional information</label><textarea id="b-notes" rows="4" placeholder="Any specific delivery format, batch size, timing..."></textarea></div>
          </div>
        </div>

        <!-- Order & Payment -->
        <div class="card">
          <div class="section summary">
            <div class="title" id="order-title">Your order</div>
            <div id="sum-items"></div>
            <div class="totals">
              <div class="row"><span id="sum-sub-label">Subtotal</span><strong id="sum-sub">$0.00</strong></div>
              <div class="row"><span id="sum-dis-label">Discounts</span><span id="sum-dis">$0.00</span></div>
              <div class="row total"><span id="sum-total-label">Total</span><strong id="sum-total">$0.00</strong></div>
            </div>

            <div class="field" style="margin-top:12px">
              <label for="coupon">Coupon Code</label>
              <div style="display:flex;gap:8px"><input id="coupon" placeholder="Enter coupon"><button class="btn" id="apply-coupon" type="button">Apply</button></div>
              <div class="muted" id="demo-coupon-hint">Demo coupon: COUPON5 (5% off)</div>
            </div>

            <div class="title" id="payment-title" style="margin-top:8px">Payment</div>
            <div class="pm-box">
              <div data-pm="cod">
                <label class="pm-option">
                  <input type="radio" name="pm" value="cod" checked>
                  <span id="pm-cod-title">üíµ Cash on Delivery (COD)</span>
                </label>
                <div class="muted" id="pm-cod-desc" style="margin-left:28px;margin-top:4px">Pay with cash upon delivery</div>
              </div>

              <div data-pm="crypto" style="margin-top:12px">
                <label class="pm-option">
                  <input type="radio" name="pm" value="crypto">
                  <span id="pm-crypto-title">‚Çø Crypto Currency Payment</span>
                </label>
                <div class="muted" id="pm-crypto-desc" style="margin-left:28px;margin-top:4px">Pay with Bitcoin, USDT, Ethereum and more via NOWPayments</div>
              </div>
            </div>

            <div class="field terms" style="margin-top:12px">
              <label for="agree" style="display: flex; align-items: center; gap: 8px;">
                <input id="agree" type="checkbox" />
                <span id="terms-text">I have read and agree to the <a href="/terms/" target="_blank" rel="noopener">website terms and conditions</a> <span style="color: #ef4444; font-size: 18px; font-weight: bold;">*</span></span>
              </label>
            </div>

            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="place-order" class="btn ok" type="button">Place Order</button>
            </div>
            <div class="muted" id="ssl-note" style="margin-top:10px">SSL secured checkout ‚Ä¢ 24/7 support available</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
  (function(){
    // ---------- constants & helpers ----------
    const PRIMARY_KEY='mp_cart_v1', LEGACY=['cart'], ALL=[PRIMARY_KEY,...LEGACY];
    const COUPON_KEY='mp_coupon_code';
    const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
    const money=n=>'$'+(Number(n)||0).toFixed(2);
    const parse=(j,f)=>{ try{ const v=JSON.parse(j); return v??f; }catch{ return f; } };
    const read=(k)=>parse(localStorage.getItem(k)||'[]',[]);
    const write=a=>{ try{ localStorage.setItem(PRIMARY_KEY, JSON.stringify(a)); }catch{} };
    const lineKey=it=>[it.id,it.unitPrice,it.payMethod].join('|');
    const norm=it=>{ const u=Number(it.unitPrice)||0, q=Math.max(1,parseInt(it.quantity,10)||1); return { id:it.id, name:it.name||it.id||'Item', payMethod:it.payMethod||'', unitPrice:+u.toFixed(2), quantity:q, currency:(it.currency||'USD').toUpperCase(), total:+(u*q).toFixed(2), ts:it.ts||Date.now() }; };
    function merge(arr){ const m=new Map(); arr.forEach(it=>{ const n=norm(it), k=lineKey(n); if(m.has(k)){ const ex=m.get(k); ex.quantity+=n.quantity; ex.total=+(ex.unitPrice*ex.quantity).toFixed(2); ex.ts=Math.max(ex.ts||0,n.ts||0); m.set(k,ex);} else m.set(k,n); }); return [...m.values()]; }
    function readAll(){ let items=[...read(PRIMARY_KEY)]; LEGACY.forEach(k=> items=items.concat(read(k))); /* no session/qs to avoid dup */ return merge(items); }
    function migrate(a){ write(a); LEGACY.forEach(k=>{ try{ localStorage.removeItem(k); }catch{} }); return a; }

    // ---------- state ----------
    let cart=migrate(readAll());
    let coupon=(localStorage.getItem(COUPON_KEY)||'').trim().toUpperCase();
    let couponPct=0;

    // ---------- country list (all ISO countries) ----------
    const COUNTRIES = [
      "Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda","Argentina","Armenia","Australia","Austria",
      "Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia",
      "Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon",
      "Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo (Congo-Brazzaville)",
      "Costa Rica","C√¥te d‚ÄôIvoire","Croatia","Cuba","Cyprus","Czechia","Democratic Republic of the Congo","Denmark","Djibouti","Dominica",
      "Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia",
      "Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea",
      "Guinea-Bissau","Guyana","Haiti","Holy See","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland",
      "Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia",
      "Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia",
      "Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia",
      "Montenegro","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger",
      "Nigeria","North Korea","North Macedonia","Norway","Oman","Pakistan","Palau","Panama","Papua New Guinea","Paraguay","Peru",
      "Philippines","Poland","Portugal","Qatar","Romania","Russia","Rwanda","Saint Kitts and Nevis","Saint Lucia",
      "Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia",
      "Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Korea",
      "South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria","Taiwan","Tajikistan","Tanzania",
      "Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu","Uganda",
      "Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan","Vanuatu","Venezuela","Vietnam",
      "Yemen","Zambia","Zimbabwe"
    ];
    (function populateCountries(){
      const sel = $('#b-country');
      if(!sel) return;
      sel.innerHTML = '';
      // default placeholder on top
      const ph = document.createElement('option');
      ph.value='';
      ph.textContent=(window.checkoutTranslations && window.checkoutTranslations.selectCountry) || 'Select country';
      sel.appendChild(ph);
      COUNTRIES.sort().forEach(c=>{
        const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);
      });
      // optional: preselect Bangladesh
      const guess = 'Bangladesh';
      if([...sel.options].some(o=>o.value===guess)) sel.value = guess;
    })();

    // ---------- render order items ----------
    const itemsEl=$('#sum-items');
    function renderItems(){
      itemsEl.innerHTML='';
      if(!cart.length){
        const emptyText = (window.checkoutTranslations && window.checkoutTranslations.cartEmpty) || 'Your cart is empty.';
        itemsEl.innerHTML='<div class="muted">'+emptyText+'</div>';
        totals();
        return;
      }
      cart.forEach(it=>{
        const line=document.createElement('div'); line.className='item';
        const t=document.createElement('div'); t.textContent=it.name;
        const q=document.createElement('div'); q.textContent='√ó '+it.quantity;
        const p=document.createElement('div'); p.textContent=money(it.total);
        line.appendChild(t); line.appendChild(q); line.appendChild(p);
        itemsEl.appendChild(line);
      });
      totals();
    }

    // ---------- totals & discounts ----------
    function calcTotals(){
      const sub=cart.reduce((s,it)=>s+(it.unitPrice||0)*(it.quantity||1),0);
      const couponDis = +(sub*(couponPct||0)).toFixed(2);
      const afterCoupon = sub - couponDis;
      
      // Check selected payment method
      const selectedPayment = document.querySelector('input[name="pm"]:checked')?.value || 'cod';
      
      // Apply crypto discount only if crypto payment is selected
      const cryptoDis = (selectedPayment === 'crypto') ? +((afterCoupon) * 0.05).toFixed(2) : 0;
      const totalDis = +(couponDis + cryptoDis).toFixed(2);
      const tot = +(afterCoupon - cryptoDis).toFixed(2);
      return {sub, couponDis, cryptoDis, totalDis, tot, pm: selectedPayment};
    }
    function totals(){
      const t=calcTotals();
      $('#sum-sub').textContent=money(t.sub);
      $('#sum-dis').textContent=t.totalDis?('-$'+t.totalDis.toFixed(2)):'$0.00';
      $('#sum-total').textContent=money(t.tot);
      return t;
    }

    // ---------- GA4 ----------
    function gaItems(){ return cart.map(it=>({item_id:it.id,item_name:it.name,price:it.unitPrice,quantity:it.quantity})); }
    function pushDL(obj){ try{ window.dataLayer=window.dataLayer||[]; window.dataLayer.push(obj); }catch{} }
    (function beginCheckout(){ const t=calcTotals(); pushDL({event:'begin_checkout',ecommerce:{currency:'USD',value:t.tot,items:gaItems()}}); })();
    
    // Track payment method selection and update totals
    document.querySelectorAll('input[name="pm"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        totals(); // Recalculate totals when payment method changes
        const t=calcTotals(); 
        pushDL({event:'add_payment_info',ecommerce:{currency:'USD',payment_type:e.target.value,value:t.tot,items:gaItems()}});
      });
    });

    // ---------- payment method visibility (admin-controlled) ----------
    async function applyPaymentVisibility() {
      try {
        const resp = await fetch(`${CONFIG.API}/payment-settings`, { cache: 'no-store' });
        if (!resp.ok) return;
        const data = await resp.json();
        if (!data || !data.success || !data.settings || !data.settings.methods) return;

        const methods = data.settings.methods;
        const enabled = {
          cod: methods.cod !== false,
          crypto: methods.crypto !== false
        };

        // Must have at least one enabled (fallback to cod)
        if (!enabled.cod && !enabled.crypto) {
          enabled.cod = true;
        }

        // Show/hide containers and disable radios accordingly
        document.querySelectorAll('[data-pm]').forEach(box => {
          const pm = box.getAttribute('data-pm');
          const isOn = enabled[pm] !== false;
          box.style.display = isOn ? '' : 'none';
          box.querySelectorAll('input[type="radio"][name="pm"]').forEach(r => {
            r.disabled = !isOn;
          });
        });

        // Ensure selected method is visible
        const selected = document.querySelector('input[name="pm"]:checked');
        const selectedVal = selected ? selected.value : null;
        if (selectedVal && enabled[selectedVal] === false) {
          const firstEnabled = document.querySelector('input[name="pm"]:not([disabled])');
          if (firstEnabled) firstEnabled.checked = true;
        }

        totals();
      } catch (e) {
        // Non-blocking
      }
    }

    applyPaymentVisibility();

    // ---------- promo/coupon validation (server-backed) ----------
    function getClientTokenFromLocal(){
      try{
        const raw = localStorage.getItem('client_auth');
        const obj = raw ? JSON.parse(raw) : null;
        return obj && obj.token ? String(obj.token) : null;
      }catch{ return null; }
    }

    async function validateCoupon(code){
      const token = getClientTokenFromLocal();
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
      const resp = await fetch(`${CONFIG.API}/promo-codes/validate?code=${encodeURIComponent(code)}`, { headers, cache: 'no-store' });
      const data = await resp.json().catch(()=>null);
      if(!resp.ok || !data || !data.success) {
        return { ok:false, message:(data && data.message) ? data.message : 'Failed to validate promo code' };
      }
      if(!data.valid) {
        return { ok:false, message:data.message || 'Invalid promo code' };
      }
      return { ok:true, discountPct: Number(data.discountPct)||0, discountPercent: Number(data.discountPercent)||0 };
    }

    async function refreshCouponFromStorage(){
      coupon=(localStorage.getItem(COUPON_KEY)||'').trim().toUpperCase();
      if(!coupon){ couponPct=0; $('#coupon').value=''; totals(); return; }
      if($('#coupon')) $('#coupon').value=coupon;
      try{
        const v = await validateCoupon(coupon);
        if(!v.ok){
          couponPct=0;
          totals();
          return;
        }
        couponPct = v.discountPct;
        totals();
      }catch{
        // Non-blocking
        couponPct=0;
        totals();
      }
    }

    // ---------- coupon ----------
    refreshCouponFromStorage();

    $('#apply-coupon')?.addEventListener('click', async ()=>{
      const code=($('#coupon')?.value||'').trim().toUpperCase();
      if(!code) return alert('Enter a coupon code.');
      try{
        const v = await validateCoupon(code);
        if(!v.ok) return alert(v.message || 'Invalid promo code');

        coupon=code;
        couponPct=v.discountPct;
        localStorage.setItem(COUPON_KEY,coupon);
        totals();
        alert(`Coupon applied: ${v.discountPercent}% off subtotal.`);
      }catch(e){
        alert('Failed to validate promo code. Please try again.');
      }
    });

    // ---------- auto-register user from billing details ----------
    async function autoRegisterUser(email, fullName, phone, country) {
      try {
        // Register user on backend via auto-register endpoint
        let token = undefined;
        try {
          const resp = await fetch(`${CONFIG.API}/auto-register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              fullName: fullName,
              email: email,
              phone: phone || '',
              country: country || ''
            })
          });
          const res = await resp.json();
          if (resp.ok && res && res.success) {
            console.log('Auto-registered user on backend:', email);
            token = res.user && res.user.token ? res.user.token : undefined;
            if (res.isNew) {
              console.log('‚úÖ New user created. They can reset password via forgot-password page.');
            } else {
              console.log('‚ÑπÔ∏è User already exists in system.');
            }
          } else {
            console.warn('Server rejected auto-register:', res && res.message);
          }
        } catch (err) {
          console.warn('Could not reach backend to auto-register user:', err);
        }

        // Also set local auth data for immediate profile access
        const authData = {
          email: email,
          fullName: fullName,
          phone: phone || '',
          country: country || '',
          authType: 'Email',
          token: token,
          loginTime: new Date().toISOString()
        };
        localStorage.setItem('client_auth', JSON.stringify(authData));
        
        console.log('Auto-created user profile for:', email);
        return true;
      } catch (error) {
        console.error('Error auto-registering user:', error);
        return false;
      }
    }

    // ---------- place order ----------
    $('#place-order')?.addEventListener('click',()=>{
      if(!cart.length) return alert('Your cart is empty.');
      const f=$('#b-first')?.value?.trim(), l=$('#b-last')?.value?.trim(), em=$('#b-email')?.value?.trim();
      if(!f||!l||!em) return alert('Please fill First name, Last name and Email.');
      if(!$('#agree')?.checked) return alert('Please accept the terms and conditions.');
      
      // Auto-register user if email doesn't exist
      const fullName = f + ' ' + l;
      const phone = $('#b-phone')?.value || '';
      const country = $('#b-country')?.value || '';
      autoRegisterUser(em, fullName, phone, country);
      
      // Get selected payment method
      const selectedPayment = document.querySelector('input[name="pm"]:checked')?.value || 'cod';
      
      const t=totals();

      // Generate unique order ID
      const orderId = 'ORD' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();

      const order={
        orderId: orderId,
        customer:{ 
          fullName: fullName,
          first:f,
          last:l, 
          phone:phone, 
          email:em, 
          extra:$('#b-extra')?.value||'', 
          country:$('#b-country')?.value||'', 
          notes:$('#b-notes')?.value||'' 
        },
        coupon: coupon||null,
        items: cart,
        totals: t,
        status: 'pending',
        paymentMethod: selectedPayment,
        createdAt: new Date().toISOString()
      };
      
      // Save to all_orders in localStorage
      try {
        const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
        allOrders.push(order);
        localStorage.setItem('all_orders', JSON.stringify(allOrders));
        
        // Set client auth for profile access
        const existingAuth = (() => {
          try { return JSON.parse(localStorage.getItem('client_auth') || 'null'); } catch { return null; }
        })();
        const authData = {
          email: em,
          fullName: f + ' ' + l,
          phone: $('#b-phone')?.value || '',
          country: $('#b-country')?.value || '',
          authType: 'Email',
          token: existingAuth && existingAuth.token ? existingAuth.token : undefined,
          loginTime: new Date().toISOString()
        };
        localStorage.setItem('client_auth', JSON.stringify(authData));
        // Send order to backend for persistent storage
        fetch(`${CONFIG.API}/save-order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        }).then(r => r.json()).then(result => {
          if (!result.success) {
            console.error('Failed to save order to backend:', result.message);
          } else {
            console.log('Order saved to backend.');
          }
        }).catch(err => {
          console.error('Error saving order to backend:', err);
        });
      } catch(err) {
        console.error('Error saving order:', err);
      }
      
      try{ sessionStorage.setItem('last_order_snapshot', JSON.stringify(order)); }catch{}
      
      // Send order confirmation email to user and admin via backend
      sendOrderConfirmationEmail(em, order);
      
      // Handle payment method
      if(selectedPayment === 'crypto') {
        // Crypto payment via NOWPayments
        createNOWPayment(order);
      } else {
        // COD - Clear cart and redirect
        cart = [];
        localStorage.removeItem('cart');
        localStorage.removeItem('mp_cart_v1');
        window.location.href = 'orderSuccess.html?orderId=' + orderId;
      }
    });

    // ---------- NOWPayments Integration ----------
    async function createNOWPayment(order) {
      const API_KEY = 'DMQ2W7C-54M4T8Y-QYVK91R-73ZA44A'; // NOWPayments API key
      
      try {
        // Create invoice using NOWPayments Invoice API
        const invoiceData = {
          price_amount: order.totals.tot,
          price_currency: 'usd',
          order_id: order.orderId,
          order_description: `Order #${order.orderId} - ${order.items.length} item(s)`,
          success_url: window.location.origin + '/orderSuccess.html?orderId=' + encodeURIComponent(order.orderId),
          cancel_url: window.location.origin + '/Checkout.html'
        };

        const response = await fetch('https://api.nowpayments.io/v1/invoice', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': API_KEY
          },
          body: JSON.stringify(invoiceData)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('NOWPayments API Error:', errorData);
          throw new Error(errorData.message || 'Payment creation failed');
        }

        const result = await response.json();
        console.log('NOWPayments Response:', result);
        
        // Save payment info to order
        const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
        const orderIndex = allOrders.findIndex(o => o.orderId === order.orderId);
        if (orderIndex !== -1) {
          allOrders[orderIndex].paymentData = {
            invoice_id: result.id,
            invoice_url: result.invoice_url,
            payment_status: result.payment_status || 'waiting',
            created_at: result.created_at
          };
          localStorage.setItem('all_orders', JSON.stringify(allOrders));
        }
        
        // Clear cart before redirect
        cart = [];
        localStorage.removeItem('cart');
        localStorage.removeItem('mp_cart_v1');
        
        // Redirect to NOWPayments invoice page
        if (result.invoice_url) {
          window.location.href = result.invoice_url;
        } else {
          alert('Payment created! Invoice ID: ' + result.id);
          window.location.href = 'orderSuccess.html?orderId=' + order.orderId;
        }
      } catch (error) {
        console.error('NOWPayments Error:', error);
        alert('Unable to process crypto payment. Please try again or contact support.\nError: ' + error.message);
        // Don't redirect, let user try again
      }
    }

    // Send order confirmation email
    async function sendOrderConfirmationEmail(email, orderData) {
      try {
        const response = await fetch(`${CONFIG.API}/send-order-confirmation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, orderData })
        });
        
        const result = await response.json();
        if (result.success) {
          console.log('‚úÖ Order confirmation email sent to:', email);
        } else {
          console.log('‚ö†Ô∏è Email not sent:', result.message);
        }
      } catch (error) {
        console.log('‚ö†Ô∏è Email service unavailable:', error.message);
        // Don't block the order flow if email fails
      }
    }

    // ---------- initial render & sync ----------
    renderItems();
    window.addEventListener('storage',ev=>{
      if(ev && ALL.includes(ev.key)){ cart=migrate(readAll()); renderItems(); }
    });
  })();
  </script>

  <script>
  // Checkout translations + keep language across pages
  (function(){
    const lang = (window.LanguageUtils && window.LanguageUtils.getLanguage) ? window.LanguageUtils.getLanguage() : 'en';
    if (window.LanguageUtils && window.LanguageUtils.applyDocumentDirection) window.LanguageUtils.applyDocumentDirection(lang);

    const T = {
      en: {
        title: 'Checkout',
        headline: 'You are almost there',
        backToCart: '‚Üê Back to cart',
        continueShopping: 'Continue shopping',
        billingTitle: 'Billing details',
        firstName: 'First name *',
        lastName: 'Last name *',
        phone: 'Phone',
        email: 'Email address *',
        extra: 'Additional Contact (WhatsApp, Telegram, Skype, Other)',
        country: 'Country / Region',
        addInfo: 'Additional information',
        notesPh: 'Any specific delivery format, batch size, timing...',
        orderTitle: 'Your order',
        subtotal: 'Subtotal',
        discounts: 'Discounts',
        total: 'Total',
        couponLabel: 'Coupon Code',
        couponPh: 'Enter coupon',
        apply: 'Apply',
        demoCoupon: 'Demo coupon: COUPON5 (5% off)',
        paymentTitle: 'Payment',
        codTitle: 'üíµ Cash on Delivery (COD)',
        codDesc: 'Pay with cash upon delivery',
        cryptoTitle: '‚Çø Crypto Currency Payment',
        cryptoDesc: 'Pay with Bitcoin, USDT, Ethereum and more via NOWPayments',
        terms: 'I have read and agree to the website terms and conditions',
        placeOrder: 'Place Order',
        ssl: 'SSL secured checkout ‚Ä¢ 24/7 support available',
        selectCountry: 'Select country',
        cartEmpty: 'Your cart is empty.'
      },
      ru: {
        title: '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞',
        headline: '–í—ã –ø–æ—á—Ç–∏ —É —Ü–µ–ª–∏',
        backToCart: '‚Üê –ù–∞–∑–∞–¥ –≤ –∫–æ—Ä–∑–∏–Ω—É',
        continueShopping: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏',
        billingTitle: '–ü–ª–∞—Ç–µ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
        firstName: '–ò–º—è *',
        lastName: '–§–∞–º–∏–ª–∏—è *',
        phone: '–¢–µ–ª–µ—Ñ–æ–Ω',
        email: 'Email *',
        extra: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç (WhatsApp, Telegram, Skype, –î—Ä—É–≥–æ–µ)',
        country: '–°—Ç—Ä–∞–Ω–∞ / –†–µ–≥–∏–æ–Ω',
        addInfo: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
        notesPh: '–§–æ—Ä–º–∞—Ç –¥–æ—Å—Ç–∞–≤–∫–∏, –ø–∞—Ä—Ç–∏—è, —Å—Ä–æ–∫–∏...',
        orderTitle: '–í–∞—à –∑–∞–∫–∞–∑',
        subtotal: '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥',
        discounts: '–°–∫–∏–¥–∫–∏',
        total: '–ò—Ç–æ–≥–æ',
        couponLabel: '–ö—É–ø–æ–Ω',
        couponPh: '–í–≤–µ–¥–∏—Ç–µ –∫—É–ø–æ–Ω',
        apply: '–ü—Ä–∏–º–µ–Ω–∏—Ç—å',
        demoCoupon: '–î–µ–º–æ –∫—É–ø–æ–Ω: COUPON5 (—Å–∫–∏–¥–∫–∞ 5%)',
        paymentTitle: '–û–ø–ª–∞—Ç–∞',
        codTitle: 'üíµ –û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ (COD)',
        codDesc: '–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ',
        cryptoTitle: '‚Çø –û–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π',
        cryptoDesc: '–û–ø–ª–∞—Ç–∞ Bitcoin, USDT, Ethereum –∏ –¥—Ä. —á–µ—Ä–µ–∑ NOWPayments',
        terms: '–Ø –ø—Ä–æ—á–∏—Ç–∞–ª(–∞) –∏ —Å–æ–≥–ª–∞—Å–µ–Ω(–Ω–∞) —Å —É—Å–ª–æ–≤–∏—è–º–∏ —Å–∞–π—Ç–∞',
        placeOrder: '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑',
        ssl: '–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ SSL ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7',
        selectCountry: '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É',
        cartEmpty: '–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.'
      },
      zh: {
        title: 'ÁªìË¥¶',
        headline: 'È©¨‰∏äÂ∞±ÂÆåÊàê‰∫Ü',
        backToCart: '‚Üê ËøîÂõûË¥≠Áâ©ËΩ¶',
        continueShopping: 'ÁªßÁª≠Ë¥≠Áâ©',
        billingTitle: 'Ë¥¶Âçï‰ø°ÊÅØ',
        firstName: 'Âêç *',
        lastName: 'Âßì *',
        phone: 'ÁîµËØù',
        email: 'ÁîµÂ≠êÈÇÆÁÆ± *',
        extra: 'ÂÖ∂‰ªñËÅîÁ≥ªÊñπÂºèÔºàWhatsApp„ÄÅTelegram„ÄÅSkype Á≠âÔºâ',
        country: 'ÂõΩÂÆ∂/Âú∞Âå∫',
        addInfo: 'ÈôÑÂä†‰ø°ÊÅØ',
        notesPh: '‰∫§‰ªòÊ†ºÂºè„ÄÅÊâπÈáèÂ§ßÂ∞è„ÄÅÊó∂Èó¥‚Ä¶',
        orderTitle: 'ÊÇ®ÁöÑËÆ¢Âçï',
        subtotal: 'Â∞èËÆ°',
        discounts: 'ÊäòÊâ£',
        total: 'ÊÄªËÆ°',
        couponLabel: '‰ºòÊÉ†Á†Å',
        couponPh: 'ËæìÂÖ•‰ºòÊÉ†Á†Å',
        apply: 'Â∫îÁî®',
        demoCoupon: 'ÊºîÁ§∫‰ºòÊÉ†Á†ÅÔºöCOUPON5ÔºàÁ´ãÂáè 5%Ôºâ',
        paymentTitle: 'ÊîØ‰ªòÊñπÂºè',
        codTitle: 'üíµ Ë¥ßÂà∞‰ªòÊ¨æÔºàCODÔºâ',
        codDesc: '‰∫§‰ªòÊó∂Áé∞ÈáëÊîØ‰ªò',
        cryptoTitle: '‚Çø Âä†ÂØÜË¥ßÂ∏ÅÊîØ‰ªò',
        cryptoDesc: 'ÈÄöËøá NOWPayments ‰ΩøÁî® Bitcoin„ÄÅUSDT„ÄÅEthereum Á≠âÊîØ‰ªò',
        terms: 'ÊàëÂ∑≤ÈòÖËØªÂπ∂ÂêåÊÑèÁΩëÁ´ôÊù°Ê¨æ‰∏éÊù°‰ª∂',
        placeOrder: '‰∏ãÂçï',
        ssl: 'SSL ÂÆâÂÖ®ÁªìË¥¶ ‚Ä¢ 24/7 ÂÆ¢ÊúçÊîØÊåÅ',
        selectCountry: 'ÈÄâÊã©ÂõΩÂÆ∂',
        cartEmpty: 'ÊÇ®ÁöÑË¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑ„ÄÇ'
      },
      ar: {
        title: 'ÿßŸÑÿØŸÅÿπ',
        headline: 'ÿ£Ÿàÿ¥ŸÉÿ™ ÿπŸÑŸâ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°',
        backToCart: 'ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ŸÑÿ© ‚Üê',
        continueShopping: 'ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ',
        billingTitle: 'ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©',
        firstName: 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ *',
        lastName: 'ÿßÿ≥ŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ© *',
        phone: 'ÿßŸÑŸáÿßÿ™ŸÅ',
        email: 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä *',
        extra: 'Ÿàÿ≥ŸäŸÑÿ© ÿ™ŸàÿßÿµŸÑ ÿ•ÿ∂ÿßŸÅŸäÿ© (Ÿàÿßÿ™ÿ≥ÿßÿ®ÿå ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖÿå ÿ≥ŸÉÿßŸäÿ®ÿå ÿ£ÿÆÿ±Ÿâ)',
        country: 'ÿßŸÑÿØŸàŸÑÿ© / ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©',
        addInfo: 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©',
        notesPh: 'ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖÿå ÿ≠ÿ¨ŸÖ ÿßŸÑÿØŸÅÿπÿ©ÿå ÿßŸÑÿ™ŸàŸÇŸäÿ™...',
        orderTitle: 'ÿ∑ŸÑÿ®ŸÉ',
        subtotal: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä',
        discounts: 'ÿßŸÑÿÆÿµŸàŸÖÿßÿ™',
        total: 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä',
        couponLabel: 'ŸÉŸàÿØ ÿßŸÑŸÇÿ≥ŸäŸÖÿ©',
        couponPh: 'ÿ£ÿØÿÆŸÑ ÿßŸÑŸÇÿ≥ŸäŸÖÿ©',
        apply: 'ÿ™ÿ∑ÿ®ŸäŸÇ',
        demoCoupon: 'ŸÇÿ≥ŸäŸÖÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©: COUPON5 (ÿÆÿµŸÖ 5%)',
        paymentTitle: 'ÿßŸÑÿØŸÅÿπ',
        codTitle: 'üíµ ÿßŸÑÿØŸÅÿπ ÿπŸÜÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ (COD)',
        codDesc: 'ÿßÿØŸÅÿπ ŸÜŸÇÿØÿßŸã ÿπŸÜÿØ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ',
        cryptoTitle: '‚Çø ÿßŸÑÿØŸÅÿπ ÿ®ÿßŸÑÿπŸÖŸÑÿßÿ™ ÿßŸÑÿ±ŸÇŸÖŸäÿ©',
        cryptoDesc: 'ÿßÿØŸÅÿπ ÿ®ŸÄ Bitcoin ŸàUSDT ŸàEthereum ŸàÿßŸÑŸÖÿ≤ŸäÿØ ÿπÿ®ÿ± NOWPayments',
        terms: 'ŸÑŸÇÿØ ŸÇÿ±ÿ£ÿ™ Ÿàÿ£ŸàÿßŸÅŸÇ ÿπŸÑŸâ ÿ¥ÿ±Ÿàÿ∑ Ÿàÿ£ÿ≠ŸÉÿßŸÖ ÿßŸÑŸÖŸàŸÇÿπ',
        placeOrder: 'ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ∑ŸÑÿ®',
        ssl: 'ÿØŸÅÿπ ÿ¢ŸÖŸÜ ÿπÿ®ÿ± SSL ‚Ä¢ ÿØÿπŸÖ 24/7',
        selectCountry: 'ÿßÿÆÿ™ÿ± ÿßŸÑÿØŸàŸÑÿ©',
        cartEmpty: 'ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ ŸÅÿßÿ±ÿ∫ÿ©.'
      }
    };

    const t = T[lang] || T.en;
    window.checkoutTranslations = { selectCountry: t.selectCountry, cartEmpty: t.cartEmpty };

    // Update country placeholder if countries already populated
    const countrySel = document.getElementById('b-country');
    if (countrySel && countrySel.options && countrySel.options.length) {
      countrySel.options[0].textContent = t.selectCountry;
    }

    // If cart is empty and message already rendered, translate it
    const itemsEl = document.getElementById('sum-items');
    if (itemsEl && /Your cart is empty\.|–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞\.|ÊÇ®ÁöÑË¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑ„ÄÇ|ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ ŸÅÿßÿ±ÿ∫ÿ©\./.test(itemsEl.textContent || '')) {
      const muted = itemsEl.querySelector('.muted');
      if (muted) muted.textContent = t.cartEmpty;
    }

    document.title = t.title;
    const h = document.getElementById('checkout-headline');
    if (h) h.textContent = t.headline;
    const back = document.getElementById('checkout-back-cart');
    if (back) back.textContent = t.backToCart;
    const cont = document.getElementById('checkout-continue-marketplace');
    if (cont) cont.textContent = t.continueShopping;

    const marketplaceUrl = (window.LanguageUtils && window.LanguageUtils.marketplacePage)
      ? window.LanguageUtils.marketplacePage(lang)
      : 'marketplace.html';
    if (cont) cont.href = marketplaceUrl;
    if (back) back.href = 'Cartpage.html';

    const bTitle = document.getElementById('billing-title');
    if (bTitle) bTitle.textContent = t.billingTitle;
    const oTitle = document.getElementById('order-title');
    if (oTitle) oTitle.textContent = t.orderTitle;
    const pTitle = document.getElementById('payment-title');
    if (pTitle) pTitle.textContent = t.paymentTitle;

    const setLabel = (forId, text) => {
      const el = document.querySelector(`label[for="${forId}"]`);
      if (el) el.textContent = text;
    };
    setLabel('b-first', t.firstName);
    setLabel('b-last', t.lastName);
    setLabel('b-phone', t.phone);
    setLabel('b-email', t.email);
    setLabel('b-extra', t.extra);
    setLabel('b-country', t.country);
    setLabel('b-notes', t.addInfo);

    const notes = document.getElementById('b-notes');
    if (notes) notes.placeholder = t.notesPh;

    const sub = document.getElementById('sum-sub-label');
    if (sub) sub.textContent = t.subtotal;
    const dis = document.getElementById('sum-dis-label');
    if (dis) dis.textContent = t.discounts;
    const tot = document.getElementById('sum-total-label');
    if (tot) tot.textContent = t.total;

    const couponLabel = document.querySelector('label[for="coupon"]');
    if (couponLabel) couponLabel.textContent = t.couponLabel;
    const coupon = document.getElementById('coupon');
    if (coupon) coupon.placeholder = t.couponPh;
    const apply = document.getElementById('apply-coupon');
    if (apply) apply.textContent = t.apply;
    const demo = document.getElementById('demo-coupon-hint');
    if (demo) demo.textContent = t.demoCoupon;

    const codT = document.getElementById('pm-cod-title');
    if (codT) codT.textContent = t.codTitle;
    const codD = document.getElementById('pm-cod-desc');
    if (codD) codD.textContent = t.codDesc;
    const crT = document.getElementById('pm-crypto-title');
    if (crT) crT.textContent = t.cryptoTitle;
    const crD = document.getElementById('pm-crypto-desc');
    if (crD) crD.textContent = t.cryptoDesc;

    const terms = document.getElementById('terms-text');
    if (terms) {
      const a = terms.querySelector('a');
      terms.innerHTML = '';
      terms.appendChild(document.createTextNode(t.terms + ' '));
      if (a) terms.appendChild(a);
      const star = document.createElement('span');
      star.textContent = ' *';
      star.style.color = '#ef4444';
      star.style.fontSize = '18px';
      star.style.fontWeight = 'bold';
      terms.appendChild(star);
    }

    const place = document.getElementById('place-order');
    if (place) place.textContent = t.placeOrder;
    const ssl = document.getElementById('ssl-note');
    if (ssl) ssl.textContent = t.ssl;
  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - BuyPvaAccount</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e9ecef;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 40px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 40px);
            border-radius: 12px;
            overflow: hidden;
        }

        .left-sidebar {
            width: 280px;
            border-right: 2px solid #e0e0e0;
            padding: 30px 20px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }

        .user-avatar {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .avatar-letter {
            color: white;
            font-size: 42px;
            font-weight: 700;
            line-height: 1;
        }

        .avatar-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.45);
            color: white;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .user-avatar:hover .avatar-overlay {
            opacity: 1;
        }

        #avatarInput {
            display: none;
        }

        .user-info {
            margin-top: 12px;
            text-align: center;
            width: 100%;
        }

        .user-name {
            font-weight: 700;
            font-size: 16px;
            color: #333;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .user-email {
            font-size: 12px;
            color: #666;
            word-break: break-word;
        }

        .sidebar-buttons {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-home {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-marketplace {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .btn-marketplace:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
            color: #667eea;
        }

        .btn-cart {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .btn-cart:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
            color: #667eea;
        }

        .sidebar-menu {
            width: 100%;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .sidebar-menu-item {
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: #666;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 15px;
            background: #dc3545;
            color: white;
            border-radius: 12px;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.5);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(220, 53, 69, 0.5);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.8);
            }
        }

        .sidebar-menu-item:hover {
            background: #f0f3ff;
            color: #667eea;
            border-left-color: #667eea;
            transform: translateX(3px);
        }

        .sidebar-menu-item.active {
            background: #667eea;
            color: white;
            border-left-color: #764ba2;
            transform: translateX(3px);
            font-weight: 600;
        }

        .user-stats-mini {
            width: 100%;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .mini-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            font-size: 13px;
        }

        .mini-stat-label {
            color: #666;
            font-weight: 500;
        }

        .mini-stat-value {
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 35px;
            animation: fadeIn 0.3s;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        .stats-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 30px;
        }

        .stats-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 140px;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
        }

        .stat-card:hover {
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
            border-color: #667eea;
        }

        .stat-card h3 {
            font-size: 13px;
            color: #666;
            font-weight: 500;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .stat-card .value {
            font-size: 22px;
            font-weight: bold;
            color: #667eea;
        }

        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 3px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }

        .stat-item:hover {
            border-left-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.1);
            transform: translateX(3px);
        }

        .stat-item h3 {
            font-size: 14px;
            color: #666;
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item .value {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }

        .order-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .order-card:hover {
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }

        .order-header {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }

        .order-id {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .order-date {
            color: #666;
            font-size: 14px;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-refunded {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-hold {
            background: #e7e8ea;
            color: #495057;
        }

        .notification-item {
            background: white;
            border: 1px solid #e9ecef;
            border-left: 3px solid #667eea;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
        }

        .notification-item:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left-color: #764ba2;
        }

        .notification-item.unread {
            background: #f8fcff;
            border-left-color: #007bff;
        }

        .notification-item.read {
            opacity: 0.85;
            background: #fafafa;
        }

        .notification-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .notification-icon {
            font-size: 20px;
            line-height: 1;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .notification-time {
            color: #999;
            font-size: 11px;
            font-weight: 500;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
            display: inline-block;
            margin-top: 6px;
        }

        .notification-message {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
            margin-top: 4px;
            margin-bottom: 4px;
        }

        .notification-item.unread .notification-message {
            color: #333;
        }

        .notification-delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
        }

        .notification-item:hover .notification-delete-btn {
            opacity: 1;
        }

        .notification-delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .notification-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-admin {
            background: #667eea;
            color: white;
        }

        .badge-order {
            background: #f5576c;
            color: white;
        }

        .badge-system {
            background: #00f2fe;
            color: white;
        }

        .notification-actions {
            margin-top: 6px;
            margin-bottom: 4px;
            display: flex;
            gap: 6px;
        }

        .notif-action-btn {
            padding: 3px 8px;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .notif-action-btn.primary {
            background: #007bff;
            color: white;
        }

        .notif-action-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .notif-action-btn:hover {
            opacity: 0.8;
        }

        .notification-unread-badge {
            background: #dc3545;
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 700;
        }

        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            color: #333;
        }

        .notifications-header h2 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }

        .mark-all-read-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mark-all-read-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }


        .download-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .download-item .info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .download-item .info p {
            color: #666;
            font-size: 14px;
        }

        .download-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .download-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .file-list {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 5px;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            margin: 20px 0 10px;
            color: #666;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item .value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .edit-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-primary, .btn-secondary {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .header h1 {
                font-size: 24px;
            }

            .logout-btn {
                position: static;
                display: block;
                margin: 15px auto 0;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1;
                min-width: 120px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .status-badge {
                margin-top: 10px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="config.js"></script>
    <script src="safe-html.js"></script>
    <script src="secure-storage.js"></script>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="left-sidebar">
                <div class="user-avatar" id="userAvatar" onclick="document.getElementById('avatarInput').click()">
                    <span class="avatar-letter" id="avatarLetter">üë§</span>
                    <div class="avatar-overlay">
                        <span>üì∑ Change Photo</span>
                    </div>
                </div>
                <input type="file" id="avatarInput" accept="image/*" onchange="uploadAvatar(event)">
                <div class="user-info">
                    <div class="user-name" id="userName">User Name</div>
                    <div class="user-email" id="userEmail">user@example.com</div>
                </div>

                <div class="sidebar-buttons">
                    <a href="marketplace.html" class="sidebar-btn btn-marketplace">
                        üõí Marketplace
                    </a>
                    <a href="Cartpage.html" class="sidebar-btn btn-cart">
                        üõçÔ∏è My Cart
                    </a>
                </div>

                <div class="sidebar-menu">
                    <button class="sidebar-menu-item" onclick="showTab('dashboard')">
                        üè† Dashboard
                    </button>
                    <button class="sidebar-menu-item" onclick="showTab('notifications')">
                        üîî Notifications
                        <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                    </button>
                    <button class="sidebar-menu-item" onclick="showTab('orders')">
                        üì¶ Order History
                    </button>
                    <button class="sidebar-menu-item" onclick="showTab('tracking')">
                        üöö Tracking
                    </button>
                    <button class="sidebar-menu-item" onclick="showTab('downloads')">
                        üì• Downloads
                    </button>
                    <button class="sidebar-menu-item" onclick="showTab('account')">
                        üë§ User Information
                    </button>
                    <button class="sidebar-menu-item" onclick="logout()" style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                        üö™ Logout
                    </button>
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto;">
                <div id="dashboard" class="tab-content active">
                    <!-- Dashboard Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                        <button class="sidebar-menu-item" onclick="showTab('dashboard')" style="margin: 0; border: 2px solid #e0e0e0; padding: 12px 24px; background: transparent; color: #333; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 16px;" onmouseover="this.style.background='#f8f9fa'; this.style.transform='translateY(-2px)'; this.style.borderColor='#667eea'; this.style.color='#667eea'" onmouseout="this.style.background='transparent'; this.style.transform='translateY(0)'; this.style.borderColor='#e0e0e0'; this.style.color='#333'">
                            üìä Dashboard Overview
                        </button>
                        <a href="marketplace.html" style="text-decoration: none; padding: 12px 24px; background: transparent; color: #667eea; border: 2px solid #667eea; border-radius: 8px; font-weight: 600; transition: all 0.3s; display: inline-block; font-size: 16px;" onmouseover="this.style.background='#667eea'; this.style.color='white'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'" onmouseout="this.style.background='transparent'; this.style.color='#667eea'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            BuyPvaAccount
                        </a>
                    </div>

                    <div class="stats-grid">
                        <div class="stats-row">
                            <div class="stat-card" onclick="showOrdersByStatus('all')" style="cursor: pointer;">
                                <h3>üì¶ Total Orders</h3>
                                <div class="value" id="totalOrders">0</div>
                            </div>
                            <div class="stat-card" onclick="showOrdersByStatus('completed')" style="cursor: pointer;">
                                <h3>‚úÖ Completed</h3>
                                <div class="value" id="completedOrders">0</div>
                            </div>
                            <div class="stat-card" onclick="showOrdersByStatus('processing')" style="cursor: pointer;">
                                <h3>‚è≥ Processing</h3>
                                <div class="value" id="processingOrders">0</div>
                            </div>
                            <div class="stat-card" onclick="showOrdersByStatus('cancelled')" style="cursor: pointer;">
                                <h3>‚ùå Cancelled</h3>
                                <div class="value" id="cancelledOrders">0</div>
                            </div>
                            <div class="stat-card" onclick="showOrdersByStatus('refunded')" style="cursor: pointer;">
                                <h3>üí∞ Refunded</h3>
                                <div class="value" id="refundedOrders">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="notifications" class="tab-content">
                    <div class="notifications-header">
                        <div>
                            <h2>Notifications</h2>
                            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.7; color: #666;">Stay updated with your orders and messages</p>
                        </div>
                        <button class="mark-all-read-btn" onclick="markAllAsRead()">
                            ‚úÖ Mark All Read
                        </button>
                    </div>
                    <div id="notificationsContainer"></div>
                </div>

                <div id="orders" class="tab-content">
                    <h2 style="margin-bottom: 20px;">My Orders</h2>
                    <div id="ordersContainer"></div>
                </div>

                <div id="tracking" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Order Tracking</h2>
                    <div id="trackingContainer">
                        <div class="empty-state">
                            <div style="font-size: 64px; opacity: 0.3;">??</div>
                            <h3>Track Your Orders</h3>
                            <p>Real-time tracking information will appear here</p>
                        </div>
                    </div>
                </div>

                <div id="downloads" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Downloads</h2>
                    <div id="downloadsContainer"></div>
                </div>

                <div id="account" class="tab-content">
                    <h2 style="margin-bottom: 20px;">User Information</h2>
                    <p style="color: #666; margin-bottom: 25px; text-align: center;">View and edit your registration details</p>
                    <div id="accountInfo"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Use secure storage for authentication data
            currentUser = secureStorage.getSensitive('client_auth') ||
                         secureStorage.get('client_auth') ||
                         JSON.parse(localStorage.getItem('client_auth') || 'null');

            if (!currentUser) {
                alert('Please login first');
                window.location.href = 'login.html';
                return;
            }

            // Best-effort: sync profile + orders from backend (works across devices)
            try {
                await syncProfileFromBackend();
                await syncOrdersFromBackend();
            } catch (e) {
                console.warn('Backend sync skipped/failed, using local data only:', e);
            }

            // Sync with users array to get all registration data
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const registeredUser = users.find(u => u.email === currentUser.email);
            if (registeredUser) {
                // Merge registration data with current user session
                currentUser = { ...registeredUser, ...currentUser };
                // Update secure storage with complete data
                secureStorage.setSensitive('client_auth', currentUser);
            }

            // Load all sections
            loadLeftSidebar();  // Load sidebar first to display user info
            loadDashboard();
            loadNotifications();
            loadOrders();
            loadTracking();
            loadDownloads();
            loadAccountInfo();
            
            // Set initial active menu item (Dashboard)
            const firstMenuItem = document.querySelector('.sidebar-menu-item');
            if (firstMenuItem) {
                firstMenuItem.classList.add('active');
            }

            // Auto-sync tracking with ordermanagement changes
            // Refresh tracking every 3 seconds to catch any order status updates
            setInterval(() => {
                if (document.querySelector('#tracking.active')) {
                    loadTracking();
                }
            }, 3000);

            // Also refresh orders every 5 seconds
            setInterval(() => {
                if (document.querySelector('#orders.active')) {
                    loadOrders();
                }
            }, 5000);

            // Also refresh notifications every 4 seconds
            setInterval(() => {
                loadNotifications();
            }, 4000);

            // Listen for storage changes from other tabs/windows (admin changes)
            window.addEventListener('storage', (e) => {
                if (e.key === 'all_orders') {
                    console.log('üì¢ Order status changed detected from admin, updating all sections...');
                    loadTracking();
                    loadOrders();
                    loadNotifications();
                    loadDashboard();
                }
                if (e.key === 'admin_notifications') {
                    console.log('üì¢ Admin notifications changed, refreshing...');
                    loadNotifications();
                }
            });

            // Also listen for local storage events from same tab using custom events
            window.addEventListener('ordersUpdated', () => {
                console.log('üì¢ Orders updated event received');
                loadTracking();
                loadOrders();
                loadNotifications();
                loadDashboard();
            });

            window.addEventListener('notificationsUpdated', () => {
                console.log('üì¢ Notifications updated event received');
                loadNotifications();
            });
        });

        function getClientToken() {
            return (currentUser && currentUser.token) ? String(currentUser.token) : null;
        }

        async function syncProfileFromBackend() {
            if (typeof CONFIG === 'undefined' || !CONFIG.API) return false;
            const token = getClientToken();
            if (!token) return false;

            const resp = await fetch(`${CONFIG.API}/me`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await resp.json().catch(() => null);
            if (!resp.ok || !data || !data.success || !data.user) return false;

            currentUser = { ...currentUser, ...data.user, token };
            secureStorage.setSensitive('client_auth', currentUser);
            try { localStorage.setItem('client_auth', JSON.stringify(currentUser)); } catch(e) {}
            return true;
        }

        async function syncOrdersFromBackend() {
            if (typeof CONFIG === 'undefined' || !CONFIG.API) return false;
            const token = getClientToken();
            if (!token) return false;

            const resp = await fetch(`${CONFIG.API}/me/orders`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await resp.json().catch(() => null);
            if (!resp.ok || !data || !data.success || !Array.isArray(data.orders)) return false;

            // Store as "all_orders" to keep the existing UI working
            try {
                localStorage.setItem('all_orders', JSON.stringify(data.orders));
                window.dispatchEvent(new Event('ordersUpdated'));
            } catch(e) {}
            return true;
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all sidebar menu items
            document.querySelectorAll('.sidebar-menu-item').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab content
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Add active class to clicked sidebar menu item
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Reload specific content when switching tabs
            if (tabName === 'account') {
                loadAccountInfo(); // Refresh user information
            } else if (tabName === 'dashboard') {
                loadDashboard(); // Refresh dashboard stats
            } else if (tabName === 'notifications') {
                loadNotifications(); // Refresh notifications
            } else if (tabName === 'orders') {
                loadOrders(); // Refresh order history
            } else if (tabName === 'tracking') {
                loadTracking(); // Refresh tracking info
            } else if (tabName === 'downloads') {
                loadDownloads(); // Refresh downloads
            }
        }

        function loadDashboard() {
            const allOrders = JSON.parse(localStorage.getItem("all_orders") || "[]");
            const userOrders = allOrders.filter(order => order.customer.email === currentUser.email);

            const totalOrders = userOrders.length;
            const completedOrders = userOrders.filter(o => o.status === 'completed').length;
            const processingOrders = userOrders.filter(o => o.status === 'processing').length;
            const cancelledOrders = userOrders.filter(o => o.status === 'cancelled').length;
            const refundedOrders = userOrders.filter(o => o.status === 'refunded').length;
            const downloads = userOrders.filter(o => 
                o.status === 'completed' && 
                o.deliveryHidden !== true &&
                (o.deliveryFile || (o.attachedFiles && o.attachedFiles.length > 0) || (o.deliveryFiles && o.deliveryFiles.length > 0))
            ).length;

            // Update top row cards
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('completedOrders').textContent = completedOrders;
            document.getElementById('processingOrders').textContent = processingOrders;
            document.getElementById('cancelledOrders').textContent = cancelledOrders;
            document.getElementById('refundedOrders').textContent = refundedOrders;
        }

        function loadDownloads() {
            console.log('Loading downloads for user:', currentUser.email);
            
            const allOrders = JSON.parse(localStorage.getItem("all_orders") || "[]");
            console.log('Total orders in system:', allOrders.length);
            
            // Filter orders that belong to this user
            const myOrders = allOrders.filter(order => order.customer.email === currentUser.email);
            console.log('My orders:', myOrders.length);
            
            // Filter orders that have delivery files (completed status recommended but not required)
            const userOrders = myOrders.filter(order => {
                const hasDeliveryFile = order.deliveryFile || (order.attachedFiles && order.attachedFiles.length > 0) || (order.deliveryFiles && order.deliveryFiles.length > 0);
                const notHidden = order.deliveryHidden !== true;
                const isCompleted = order.status.toLowerCase() === "completed";
                
                console.log(`Order ${order.orderId}:`, {
                    status: order.status,
                    hasDeliveryFile,
                    notHidden,
                    isCompleted,
                    deliveryFile: order.deliveryFile,
                    attachedFilesCount: order.attachedFiles ? order.attachedFiles.length : 0,
                    deliveryFilesCount: order.deliveryFiles ? order.deliveryFiles.length : 0
                });
                
                // Show if has delivery files and not hidden (prefer completed orders)
                return hasDeliveryFile && notHidden;
            });
            
            console.log('Orders with delivery files:', userOrders.length);

            const container = document.getElementById("downloadsContainer");

            if (userOrders.length === 0) {
                safeSetInnerHTML(container, `<div class="empty-state">
                    <div style="font-size: 64px; opacity: 0.3;">üì•</div>
                    <h3>No Downloads Available</h3>
                    <p>Once your order is completed and the admin sends delivery files, they will appear here for download.</p>
                </div>`, true);
                return;
            }

            const downloadsHTML = userOrders.map(order => {
                const productNames = order.items.map(item => item.name).join(', ');
                const totalQuantity = order.items.reduce((sum, item) => sum + item.quantity, 0);
                const hasDeliveryFile = order.deliveryFile || (order.attachedFiles && order.attachedFiles.length > 0) || (order.deliveryFiles && order.deliveryFiles.length > 0);

                return `<div class="order-card" style="margin-bottom: 12px;">
                    <div class="order-header">
                        <div class="order-id">#${order.orderId}</div>
                        <div class="order-date">${new Date(order.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div style="flex: 1; font-size: 13px; color: #555;">
                        <strong>Products:</strong> ${productNames} (${totalQuantity} items)
                    </div>
                    ${order.deliveryDate ? `
                        <div style="font-size: 11px; color: #28a745; white-space: nowrap; margin-right: 10px;">
                            ‚úÖ Delivered: ${new Date(order.deliveryDate).toLocaleDateString()}
                        </div>
                    ` : ''}
                    <span class="status-badge status-${order.status}">${order.status}</span>
                </div>
                
                ${order.deliveryFile ? `
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <strong style="font-size: 13px; color: #333; display: block; margin-bottom: 6px;">üìÑ Delivery Information:</strong>
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">${order.deliveryFile.replace(/\n/g, '<br>')}</div>
                </div>
                ` : ''}

                ${order.deliveryFiles && order.deliveryFiles.length > 0 ? `
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <strong style="font-size: 13px; color: #333; display: block; margin-bottom: 8px;">üìé Delivery Files (${order.deliveryFiles.length}):</strong>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        ${order.deliveryFiles.map(file => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üìÑ ${file.name}</div>
                                    <div style="font-size: 11px; color: #666; word-break: break-all;">${file.url || ''}</div>
                                </div>
                                <button style="padding: 5px 12px; font-size: 11px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 10px;" 
                                    onmouseover="this.style.background='#5568d3'" 
                                    onmouseout="this.style.background='#667eea'" 
                                    onclick="downloadAttachedFile('${order.orderId}', '${file.name}')">
                                    üì• Download
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${order.attachedFiles && order.attachedFiles.length > 0 ? `
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <strong style="font-size: 13px; color: #333; display: block; margin-bottom: 8px;">üìé Files (${order.attachedFiles.length}):</strong>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        ${order.attachedFiles.map(file => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üìÑ ${file.name}</div>
                                    <div style="font-size: 11px; color: #666;">${(file.size / 1024).toFixed(2)} KB</div>
                                </div>
                                <button style="padding: 5px 12px; font-size: 11px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 10px;" 
                                    onmouseover="this.style.background='#5568d3'" 
                                    onmouseout="this.style.background='#667eea'" 
                                    onclick="downloadAttachedFile('${order.orderId}', '${file.name}')">
                                    üì• Download
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${!order.deliveryFile && (!order.attachedFiles || order.attachedFiles.length === 0) && (!order.deliveryFiles || order.deliveryFiles.length === 0) ? `
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <strong style="color: #856404; font-size: 12px;">‚è≥ Waiting for Delivery</strong>
                </div>
                ` : ''}`;
            }).join('');

            // Use safe HTML rendering to prevent XSS
            safeSetInnerHTML(container, downloadsHTML, true);

            // Remove duplicate line that was causing issues
            // container.innerHTML = downloadsHTML;
        }

        function downloadAttachedFile(orderId, fileName) {
            console.log('Downloading file:', fileName, 'from order:', orderId);
            
            const allOrders = JSON.parse(localStorage.getItem("all_orders") || "[]");
            const order = allOrders.find(o => o.orderId === orderId);
            
            if (!order) {
                console.error('Order not found:', orderId);
                alert('Order not found!');
                return;
            }
            
            // Prefer attachedFiles (base64)
            const attached = (order.attachedFiles || []).find(f => f.name === fileName);
            if (attached) {
                console.log('File found, downloading...', attached.name, attached.type, attached.size);
                try {
                    const a = document.createElement('a');
                    a.href = attached.data;
                    a.download = attached.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    console.log('Download initiated successfully');
                    return;
                } catch (error) {
                    console.error('Download error:', error);
                    alert('Error downloading file: ' + error.message);
                    return;
                }
            }

            // Fallback: deliveryFiles (URL)
            const delivery = (order.deliveryFiles || []).find(f => f.name === fileName);
            if (delivery && delivery.url) {
                window.open(delivery.url, '_blank', 'noopener');
                return;
            }

            console.error('File not found:', fileName);
            alert('File not found!');
            
        }

        function base64ToBlob(base64String, mimeType) {
            // Handle data URL format (data:mime/type;base64,xxxxx)
            let base64 = base64String;
            if (base64String.includes(',')) {
                base64 = base64String.split(',')[1];
            }
            
            const binary = atob(base64);
            const array = [];
            for (let i = 0; i < binary.length; i++) {
                array.push(binary.charCodeAt(i));
            }
            return new Blob([new Uint8Array(array)], { type: mimeType });
        }

        async function loadNotifications() {
            const userEmail = (currentUser && currentUser.email) ? String(currentUser.email) : String(localStorage.getItem('user_email') || '');
            const emailLower = userEmail.toLowerCase();

            const allOrders = JSON.parse(localStorage.getItem("all_orders") || "[]");
            const userOrders = allOrders.filter(order => {
                const orderEmail = (order && order.customer && order.customer.email) ? order.customer.email : order.email;
                return orderEmail && emailLower && String(orderEmail).toLowerCase() === emailLower;
            });

            // 1) Backend-persisted notifications (cross-device)
            let serverAdminNotifs = [];
            try {
                const auth = JSON.parse(localStorage.getItem('client_auth') || 'null');
                if (auth && auth.token) {
                    const res = await fetch(`${CONFIG.API}/me/notifications`, {
                        headers: { 'Authorization': `Bearer ${auth.token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const list = (data && Array.isArray(data.notifications)) ? data.notifications : [];
                        serverAdminNotifs = list
                            .filter(n => !n.email || String(n.email).toLowerCase() === emailLower)
                            .map(n => ({
                                id: n.id || ('srv-' + Date.now() + '-' + Math.random().toString(16).slice(2)),
                                icon: n.icon || 'üì¢',
                                title: n.title || 'Admin Message',
                                message: n.message || n.text || 'You have a new message from admin.',
                                date: n.sentDate || n.createdAt || n.timestamp || new Date().toISOString(),
                                type: 'admin',
                                read: false,
                                orderId: n.orderId || null
                            }));
                    }
                }
            } catch (e) {}

            // 2) Local admin notifications fallback
            const adminNotifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');
            const localAdminNotifs = adminNotifications
                .filter(n => {
                    const nEmail = n.email || n.userEmail;
                    return nEmail && emailLower && String(nEmail).toLowerCase() === emailLower;
                })
                .map(n => ({
                    id: n.id || 'admin-' + Date.now(),
                    icon: n.icon || 'üì¢',
                    title: n.title || 'Admin Message',
                    message: n.message || 'You have a new message from admin.',
                    date: n.sentDate || n.timestamp || new Date().toISOString(),
                    type: 'admin',
                    read: n.read || false,
                    orderId: n.orderId || null
                }));

            // Merge + de-dup admin notifications
            const adminMap = new Map();
            [...serverAdminNotifs, ...localAdminNotifs].forEach(n => {
                const key = n.id || `${n.title}||${n.message}||${n.date}`;
                if (!adminMap.has(key)) adminMap.set(key, n);
            });
            const userAdminNotifs = Array.from(adminMap.values());

            // Generate order-based notifications with more detail
            const orderNotifications = userOrders.map(order => {
                let icon = 'üì¶';
                let title = 'Order Update';
                let message = '';

                switch(order.status) {
                    case 'completed':
                        icon = '‚úÖ';
                        title = 'Order Completed';
                        message = `Your order #${order.orderId} has been completed successfully!`;
                        break;
                    case 'processing':
                        icon = '‚öôÔ∏è';
                        title = 'Order Processing';
                        message = `Your order #${order.orderId} is being processed.`;
                        break;
                    case 'confirmed':
                        icon = '‚úîÔ∏è';
                        title = 'Order Confirmed';
                        message = `Your order #${order.orderId} has been confirmed.`;
                        break;
                    case 'cancelled':
                        icon = '‚ùå';
                        title = 'Order Cancelled';
                        message = `Your order #${order.orderId} has been cancelled.`;
                        break;
                    case 'refunded':
                        icon = 'üí∞';
                        title = 'Order Refunded';
                        message = `Your order #${order.orderId} has been refunded.`;
                        break;
                    case 'hold':
                        icon = '‚è∏Ô∏è';
                        title = 'Order On Hold';
                        message = `Your order #${order.orderId} is currently on hold.`;
                        break;
                    default:
                        icon = 'üÜï';
                        title = 'New Order';
                        message = `Your order #${order.orderId} has been placed.`;
                }

                return {
                    id: `order-${order.orderId}`,
                    icon: icon,
                    title: title,
                    message: message,
                    date: order.createdAt,
                    type: 'order',
                    orderId: order.orderId
                };
            });

            // Status history notifications (one per transition)
            const historyNotifications = [];
            userOrders.forEach(order => {
                const history = Array.isArray(order.statusHistory) ? order.statusHistory : [];
                history.forEach((h, index) => {
                    const fromStatus = (h && h.from != null) ? String(h.from) : '';
                    const toStatus = (h && h.to != null) ? String(h.to) : '';
                    const ts = (h && h.timestamp) ? h.timestamp : (order.statusUpdatedAt || order.lastUpdated || order.createdAt || new Date().toISOString());

                    let icon = 'üìå';
                    const toLower = toStatus.toLowerCase();
                    if (toLower === 'confirmed') icon = '‚úîÔ∏è';
                    else if (toLower === 'processing') icon = '‚öôÔ∏è';
                    else if (toLower === 'completed') icon = '‚úÖ';
                    else if (toLower === 'cancelled') icon = '‚ùå';
                    else if (toLower === 'refunded') icon = 'üí∞';
                    else if (toLower === 'hold') icon = '‚è∏Ô∏è';

                    historyNotifications.push({
                        id: `status-${order.orderId}-${h && h.timestamp ? h.timestamp : index}`,
                        icon,
                        title: `Order #${order.orderId} Status Changed`,
                        message: `${fromStatus || 'unknown'} ‚Üí ${toStatus || 'unknown'}`,
                        date: ts,
                        type: 'order',
                        orderId: order.orderId
                    });
                });
            });

            // Combine all notifications
            const allNotifications = [
                ...userAdminNotifs.map(n => ({
                    id: n.id || 'admin-' + Date.now(),
                    icon: n.icon || 'üì¢',
                    title: n.title || 'Admin Message',
                    message: n.message || 'You have a new message from admin.',
                    date: n.sentDate || n.timestamp || new Date().toISOString(),
                    type: 'admin',
                    read: n.read || false
                })),
                ...historyNotifications,
                ...orderNotifications
            ];

            // Get deleted notifications for this user
            const deletedNotifications = JSON.parse(localStorage.getItem(`deleted_notifications_${userEmail}`) || "[]");
            
            // Filter out deleted notifications
            const visibleNotifications = allNotifications.filter(n => !deletedNotifications.includes(n.id));

            // Sort by date (newest first)
            visibleNotifications.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Get read notifications
            const readNotifications = JSON.parse(localStorage.getItem(`read_notifications_${userEmail}`) || "[]");

            const container = document.getElementById("notificationsContainer");

            if (visibleNotifications.length === 0) {
                safeSetInnerHTML(container, `<div class="empty-state">
                    <div style="font-size: 64px; opacity: 0.3;">üîî</div>
                    <h3>No Notifications</h3>
                    <p>You have no notifications at the moment.</p>
                </div>`, true);
                const badge = document.getElementById('notificationBadge');
                if (badge) badge.style.display = 'none';
                return;
            }

            // Count unread notifications
            const unreadCount = visibleNotifications.filter(n => !readNotifications.includes(n.id)).length;
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }

            const notificationsHTML = visibleNotifications.map(notif => {
                const isRead = readNotifications.includes(notif.id);
                let badgeClass = 'badge-system';
                let badgeText = 'System';
                
                if (notif.type === 'admin') {
                    badgeClass = 'badge-admin';
                    badgeText = 'Admin Message';
                } else if (notif.type === 'order') {
                    badgeClass = 'badge-order';
                    badgeText = 'Order Update';
                }

                return `<div class="notification-item ${isRead ? 'read' : 'unread'}" onclick="markAsRead(this, '${notif.id}')">
                    <button class="notification-delete-btn" onclick="event.stopPropagation(); deleteNotification('${notif.id}', '${notif.type}')" title="Delete notification">√ó</button>
                    <div class="notification-header">
                        <span class="notification-icon">${notif.icon}</span>
                        <div class="notification-content">
                            <div class="notification-title">
                                ${notif.title}
                                ${!isRead ? '<span class="notification-unread-badge">NEW</span>' : ''}
                                <span class="notification-type-badge ${badgeClass}">${badgeText}</span>
                                ${notif.orderId ? `
                                <button class="notif-action-btn primary" onclick="event.stopPropagation(); showTab('tracking')">
                                    üì¶ Track Order
                                </button>
                                <button class="notif-action-btn secondary" onclick="event.stopPropagation(); showTab('orders')">
                                    üìã View Orders
                                </button>
                                ` : ''}
                                <span class="notification-time">${getTimeAgo(notif.date)}</span>
                            </div>
                            <div class="notification-message">${notif.message}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            safeSetInnerHTML(container, notificationsHTML, true);
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 2592000) return Math.floor(seconds / 86400) + ' days ago';
            return new Date(timestamp).toLocaleDateString();
        }

        function markAsRead(element, notifId) {
            const readNotifications = JSON.parse(localStorage.getItem(`read_notifications_${currentUser.email}`) || "[]");
            
            if (!readNotifications.includes(notifId)) {
                readNotifications.push(notifId);
                localStorage.setItem(`read_notifications_${currentUser.email}`, JSON.stringify(readNotifications));
                element.classList.remove('unread');
                element.classList.add('read');
                
                // Update badge count
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    const currentCount = parseInt(badge.textContent) || 0;
                    const newCount = currentCount - 1;
                    if (newCount > 0) {
                        badge.textContent = newCount > 99 ? '99+' : newCount;
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
        }

        function deleteNotification(notifId, notifType) {
            if (!confirm('Are you sure you want to delete this notification?')) {
                return;
            }

            // Store deleted notification ID for this user only (doesn't delete from admin)
            const deletedNotifications = JSON.parse(localStorage.getItem(`deleted_notifications_${currentUser.email}`) || "[]");
            
            if (!deletedNotifications.includes(notifId)) {
                deletedNotifications.push(notifId);
                localStorage.setItem(`deleted_notifications_${currentUser.email}`, JSON.stringify(deletedNotifications));
            }

            // Reload notifications to reflect the deletion
            loadNotifications();
        }

        function markAllAsRead() {
            const allOrders = JSON.parse(localStorage.getItem("all_orders") || "[]");
            const userOrders = allOrders.filter(order => order.customer.email === currentUser.email);
            const adminNotifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');
            const userAdminNotifs = adminNotifications.filter(n => 
                n.email && n.email.toLowerCase() === currentUser.email.toLowerCase()
            );

            // Status history notification IDs
            const historyNotifIds = [];
            userOrders.forEach(order => {
                const history = Array.isArray(order.statusHistory) ? order.statusHistory : [];
                history.forEach((h, index) => {
                    historyNotifIds.push(`status-${order.orderId}-${h && h.timestamp ? h.timestamp : index}`);
                });
            });

            // Generate all notification IDs
            const allNotifIds = [
                ...userAdminNotifs.map(n => n.id || 'admin-' + Date.now()),
                ...historyNotifIds,
                ...userOrders.map(order => `order-${order.orderId}`)
            ];

            // Mark all as read
            localStorage.setItem(`read_notifications_${currentUser.email}`, JSON.stringify(allNotifIds));
            
            // Reload notifications
            loadNotifications();
            
            alert('? All notifications marked as read!');
        }

        // Show orders filtered by status
        function showOrdersByStatus(status) {
            // Switch to orders tab
            showTab('orders');
            
            // Filter and display orders
            const allOrders = JSON.parse(localStorage.getItem("all_orders") || "[]");
            let userOrders = allOrders.filter(order => order.customer.email === currentUser.email);
            
            // Filter by status if not 'all'
            if (status !== 'all') {
                userOrders = userOrders.filter(order => order.status === status);
            }

            const container = document.getElementById("ordersContainer");

            if (userOrders.length === 0) {
                safeSetInnerHTML(container, `<div class="empty-state">
                    <div style="font-size: 64px; opacity: 0.3;">üì¶</div>
                    <h3>No ${status === 'all' ? '' : status.charAt(0).toUpperCase() + status.slice(1)} Orders</h3>
                    <p>You don't have any ${status === 'all' ? '' : status} orders yet.</p>
                </div>`, true);
                return;
            }

            // Sort orders by date (newest first)
            userOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const ordersHTML = userOrders.map(order => {
                const productNames = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');

                return `<div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">#${order.orderId}</div>
                            <div class="order-date">${new Date(order.createdAt).toLocaleDateString()}</div>
                        </div>
                        <span class="status-badge status-${order.status}">${order.status}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Products:</strong> ${productNames}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Total:</strong> $${order.totals.tot.toFixed(2)}
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        <strong>Payment:</strong> ${order.paymentMethod === 'cod' ? 'Cash on Delivery' : order.paymentMethod}
                    </div>
                </div>`;
            }).join('');

            safeSetInnerHTML(container, ordersHTML, true);
        }


        function loadOrders() {
            const allOrders = JSON.parse(localStorage.getItem("all_orders") || "[]");
            const userOrders = allOrders.filter(order => order.customer.email === currentUser.email);

            const container = document.getElementById("ordersContainer");

            if (userOrders.length === 0) {
                safeSetInnerHTML(container, `<div class="empty-state">
                    <div style="font-size: 64px; opacity: 0.3;">üì¶</div>
                    <h3>No Orders Yet</h3>
                    <p>Your orders will appear here.</p>
                </div>`, true);
                return;
            }

            // Sort orders by date (newest first)
            userOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const ordersHTML = userOrders.map(order => {
                const productNames = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');

                return `<div class="order-card">
                    <div class="order-header">
                        <div class="order-id">#${order.orderId}</div>
                        <div class="order-date">${new Date(order.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div style="flex: 1; font-size: 13px; color: #555;">
                        <strong>Products:</strong> ${productNames}
                    </div>
                    <div style="font-size: 13px; color: #555; white-space: nowrap; margin-right: 10px;">
                        <strong>Total:</strong> $${order.totals.tot.toFixed(2)}
                    </div>
                    <div style="font-size: 13px; color: #555; white-space: nowrap; margin-right: 10px;">
                        <strong>Payment:</strong> ${order.paymentMethod === 'cod' ? 'COD' : order.paymentMethod}
                    </div>
                    <span class="status-badge status-${order.status}">${order.status}</span>
                </div>`;
            }).join('');

            safeSetInnerHTML(container, ordersHTML, true);
        }

        function loadTracking() {
            const allOrders = JSON.parse(localStorage.getItem("all_orders") || "[]");
            const userOrders = allOrders.filter(order => order.customer.email === currentUser.email);

            const container = document.getElementById("trackingContainer");

            if (userOrders.length === 0) {
                safeSetInnerHTML(container, `<div class="empty-state">
                    <div style="font-size: 64px; opacity: 0.3;">üöö</div>
                    <h3>No Orders to Track</h3>
                    <p>Your order tracking information will appear here once you place an order.</p>
                </div>`, true);
                return;
            }

            // Sort orders by date (newest first)
            userOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const trackingHTML = userOrders.map(order => {
                // Define tracking stages with progressive activation based on order status
                const orderStatus = order.status.toLowerCase();
                
                // Determine which stages should be active based on current status
                let activeStages = [];
                switch(orderStatus) {
                    case 'pending':
                        activeStages = ['pending'];
                        break;
                    case 'confirmed':
                        activeStages = ['pending', 'confirmed'];
                        break;
                    case 'processing':
                        activeStages = ['pending', 'confirmed', 'processing'];
                        break;
                    case 'completed':
                        activeStages = ['pending', 'confirmed', 'processing', 'completed'];
                        break;
                    default:
                        activeStages = ['pending']; // For other statuses, show at least pending
                }
                
                const stages = [
                    { 
                        name: 'Order Placed', 
                        icon: 'üì¶', 
                        status: 'pending', 
                        active: activeStages.includes('pending'),
                        isCurrent: orderStatus === 'pending'
                    },
                    { 
                        name: 'Confirmed', 
                        icon: '‚úîÔ∏è', 
                        status: 'confirmed', 
                        active: activeStages.includes('confirmed'),
                        isCurrent: orderStatus === 'confirmed'
                    },
                    { 
                        name: 'Processing', 
                        icon: '‚öôÔ∏è', 
                        status: 'processing', 
                        active: activeStages.includes('processing'),
                        isCurrent: orderStatus === 'processing'
                    },
                    { 
                        name: 'Completed', 
                        icon: '‚úÖ', 
                        status: 'completed', 
                        active: activeStages.includes('completed'),
                        isCurrent: orderStatus === 'completed'
                    }
                ];

                // Special statuses
                const isCancelled = orderStatus === 'cancelled';
                const isRefunded = orderStatus === 'refunded';
                const isOnHold = orderStatus === 'hold';

                const productNames = order.items.map(item => item.name).join(', ');
                const totalQuantity = order.items.reduce((sum, item) => sum + item.quantity, 0);

                // Get status history if available
                const statusHistory = order.statusHistory || [];
                const statusHistoryHTML = statusHistory.length > 0 ? `
                    <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-top: 12px;">
                        <strong style="font-size: 12px; color: #666; display: block; margin-bottom: 8px;">üìã Status History:</strong>
                        <div style="font-size: 12px;">
                            ${statusHistory.map(hist => `
                                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e0e0e0;">
                                    <span style="color: #666;">${hist.from || 'Initial'} ‚Üí <strong style="color: #333;">${hist.to}</strong></span>
                                    <span style="color: #999;">${new Date(hist.timestamp).toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';

                return `<div class="order-card">
                    <div class="order-header">
                        <div class="order-id">#${order.orderId}</div>
                        <div class="order-date">${new Date(order.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div style="flex: 1; font-size: 13px; color: #555;">
                        <strong>Products:</strong> ${productNames} (${totalQuantity} items)
                    </div>
                    <div style="font-size: 13px; color: #555; white-space: nowrap; margin-right: 10px;">
                        <strong>Total:</strong> $${order.totals.tot.toFixed(2)}
                    </div>
                    <span class="status-badge status-${order.status}">${order.status}</span>
                </div>
                
                ${!isCancelled && !isRefunded && !isOnHold ? `
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; position: relative;">
                        ${stages.map((stage, index) => `
                            <div style="flex: 1; text-align: center; position: relative; z-index: 2;">
                                <div style="width: 40px; height: 40px; margin: 0 auto 6px; border-radius: 50%; background: ${stage.active ? '#667eea' : '#e0e0e0'}; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 2px solid ${stage.isCurrent ? '#28a745' : 'white'}; box-shadow: ${stage.isCurrent ? '0 0 0 4px rgba(40, 167, 69, 0.2)' : 'none'};">
                                    ${stage.icon}
                                </div>
                                <div style="font-size: 11px; font-weight: 600; color: ${stage.active ? '#333' : '#999'};">
                                    ${stage.name}
                                </div>
                            </div>
                            ${index < stages.length - 1 ? `
                                <div style="flex: 1; height: 2px; background: ${stages[index + 1].active ? '#667eea' : '#e0e0e0'}; margin: 0 -10px; margin-bottom: 35px; position: relative; z-index: 1;"></div>
                            ` : ''}
                        `).join('')}
                    </div>
                    ${statusHistoryHTML}
                </div>
                ` : isCancelled ? `
                <div style="background: #fee; border: 1px solid #dc3545; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <strong style="color: #dc3545;">‚ùå Order Cancelled</strong>
                </div>
                ${statusHistoryHTML}
                ` : isRefunded ? `
                <div style="background: #f0f0f0; border: 1px solid #6c757d; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <strong style="color: #6c757d;">üí∞ Order Refunded</strong>
                </div>
                ${statusHistoryHTML}
                ` : `
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <strong style="color: #856404;">‚è∏Ô∏è Order On Hold</strong>
                </div>
                ${statusHistoryHTML}
                `}`;
            }).join('');

            safeSetInnerHTML(container, trackingHTML, true);
        }

        function loadAccountInfo() {
            console.log('Loading account info, currentUser:', currentUser);
            
            const container = document.getElementById('accountInfo');
            if (!container) {
                console.error('accountInfo container not found');
                return;
            }

            if (!currentUser) {
                console.error('currentUser is null');
                safeSetInnerHTML(container, '<p style="text-align: center; color: #dc3545;">Error: User data not found. Please login again.</p>', true);
                return;
            }

            try {
                const fullName = currentUser.fullName || '';
                const email = currentUser.email || '';
                const phone = currentUser.phone || '';
                const country = currentUser.country || '';
                const authType = currentUser.authType || 'Email';
                const createdAt = currentUser.createdAt ? new Date(currentUser.createdAt).toLocaleDateString() : 'N/A';

                console.log('Displaying user info:', {
                    fullName,
                    email,
                    phone,
                    country,
                    authType,
                    createdAt
                });

                safeSetInnerHTML(container, `
                    <div class="edit-form">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="editFullName" value="${fullName}" placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editEmail" value="${email}" disabled>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editPhone" value="${phone}" placeholder="Enter your phone number">
                        </div>
                        <div class="form-group">
                            <label>Country</label>
                            <select id="editCountry">
                                <option value="">Select your country</option>
                                <option value="Bangladesh" ${country === 'Bangladesh' ? 'selected' : ''}>Bangladesh</option>
                                <option value="India" ${country === 'India' ? 'selected' : ''}>India</option>
                                <option value="Pakistan" ${country === 'Pakistan' ? 'selected' : ''}>Pakistan</option>
                                <option value="United States" ${country === 'United States' ? 'selected' : ''}>United States</option>
                                <option value="United Kingdom" ${country === 'United Kingdom' ? 'selected' : ''}>United Kingdom</option>
                                <option value="Canada" ${country === 'Canada' ? 'selected' : ''}>Canada</option>
                                <option value="Australia" ${country === 'Australia' ? 'selected' : ''}>Australia</option>
                                <option value="Other" ${country === 'Other' || (country && !['Bangladesh', 'India', 'Pakistan', 'United States', 'United Kingdom', 'Canada', 'Australia'].includes(country)) ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="editPassword" placeholder="Enter new password (leave blank to keep current)">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="editConfirmPassword" placeholder="Confirm new password">
                        </div>
                        <div class="form-group">
                            <label>Account Type</label>
                            <input type="text" value="${authType}" disabled>
                        </div>
                        <div class="form-group">
                            <label>Member Since</label>
                            <input type="text" value="${createdAt}" disabled>
                        </div>
                        <div class="btn-group">
                            <button class="btn-primary" onclick="saveAccountChanges()">?? Save Changes</button>
                            <button class="btn-secondary" onclick="loadAccountInfo()">? Reset</button>
                        </div>
                    </div>
                `, true);
                console.log('Account info loaded successfully');
            } catch (error) {
                console.error('Error loading account info:', error);
                safeSetInnerHTML(container, '<p style="text-align: center; color: #dc3545;">Error loading user information. Please try again.</p>', true);
            }
        }

        async function saveAccountChanges() {
            const fullName = document.getElementById('editFullName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const country = document.getElementById('editCountry').value.trim();
            const password = document.getElementById('editPassword').value;
            const confirmPassword = document.getElementById('editConfirmPassword').value;

            // Validate password if provided
            if (password) {
                if (password.length < 6) {
                    alert('Password must be at least 6 characters long');
                    return;
                }
                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
            }

            const token = getClientToken();
            if (typeof CONFIG !== 'undefined' && CONFIG.API && token) {
                // Update profile
                const resp = await fetch(`${CONFIG.API}/me`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ fullName, phone, country })
                });
                const result = await resp.json().catch(() => null);
                if (!resp.ok || !result || !result.success) {
                    alert((result && result.message) ? result.message : 'Failed to update profile');
                    return;
                }
                currentUser = { ...currentUser, ...result.user, token };
                secureStorage.setSensitive('client_auth', currentUser);
                try { localStorage.setItem('client_auth', JSON.stringify(currentUser)); } catch(e) {}

                // Update password if provided
                if (password) {
                    const pwResp = await fetch(`${CONFIG.API}/me/password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ password })
                    });
                    const pwResult = await pwResp.json().catch(() => null);
                    if (!pwResp.ok || !pwResult || !pwResult.success) {
                        alert((pwResult && pwResult.message) ? pwResult.message : 'Password update failed');
                        return;
                    }
                }
            } else {
                // Fallback: local-only update
                currentUser.fullName = fullName;
                currentUser.phone = phone;
                currentUser.country = country;
                localStorage.setItem('client_auth', JSON.stringify(currentUser));
            }

            // Refresh sidebar and account info
            loadLeftSidebar();

            alert('? Account information updated successfully!');
            
            // Clear password fields
            document.getElementById('editPassword').value = '';
            document.getElementById('editConfirmPassword').value = '';
        }

        function uploadAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('Image size should be less than 2MB');
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                // Save to localStorage
                currentUser.avatarImage = imageData;
                localStorage.setItem('client_auth', JSON.stringify(currentUser));

                // Update in users array
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex].avatarImage = imageData;
                    localStorage.setItem('users', JSON.stringify(users));
                }

                // Update display
                loadLeftSidebar();
                alert('? Profile photo updated successfully!');
            };
            reader.readAsDataURL(file);
        }

        function loadLeftSidebar() {
            console.log('loadLeftSidebar called, currentUser:', currentUser);
            
            if (!currentUser) {
                console.error('No current user found');
                return;
            }

            const avatarElement = document.getElementById('userAvatar');
            const avatarLetterElement = document.getElementById('avatarLetter');
            const userNameElement = document.getElementById('userName');
            const userEmailElement = document.getElementById('userEmail');
            
            console.log('DOM Elements found:', {
                avatarElement: !!avatarElement,
                avatarLetterElement: !!avatarLetterElement,
                userNameElement: !!userNameElement,
                userEmailElement: !!userEmailElement
            });

            // Set user name and email FIRST
            if (userNameElement) {
                const displayName = currentUser.fullName || currentUser.email || 'User Name';
                userNameElement.textContent = displayName;
                console.log('Set userName to:', displayName);
            } else {
                console.error('userName element not found!');
            }
            
            if (userEmailElement) {
                const displayEmail = currentUser.email || 'No email';
                userEmailElement.textContent = displayEmail;
                console.log('Set userEmail to:', displayEmail);
            } else {
                console.error('userEmail element not found!');
            }
            
            if (avatarElement) {
                // Check if user has a custom avatar image
                if (currentUser.avatarImage) {
                    avatarElement.style.backgroundImage = `url(${currentUser.avatarImage})`;
                    if (avatarLetterElement) {
                        avatarLetterElement.style.display = 'none';
                    }
                } else {
                    // Set default avatar (first letter of name or email)
                    const userName = currentUser.fullName || currentUser.email || 'User';
                    const avatarLetter = userName.charAt(0).toUpperCase();
                    avatarElement.style.backgroundImage = 'none';
                    if (avatarLetterElement) {
                        avatarLetterElement.textContent = avatarLetter;
                        avatarLetterElement.style.display = 'block';
                    }
                }
            }

            console.log('Sidebar loaded:', {
                fullName: currentUser.fullName,
                email: currentUser.email,
                hasAvatar: !!currentUser.avatarImage
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear sensitive authentication data
                secureStorage.removeSensitive('client_auth');
                secureStorage.remove('client_auth');
                localStorage.removeItem('client_auth');
                localStorage.removeItem('client_auth_migrated');

                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>

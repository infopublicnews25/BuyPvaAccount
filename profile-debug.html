<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile System Debug - BuyPvaAccount</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }
        h2 {
            color: #569cd6;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .stat {
            display: inline-block;
            background: #0e639c;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px 5px 5px 0;
            font-weight: bold;
        }
        .stat.zero { background: #6a1b1b; }
        .stat.positive { background: #16a34a; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-family: inherit;
        }
        button:hover {
            background: #1177bb;
        }
        button.danger {
            background: #d13438;
        }
        button.danger:hover {
            background: #e81123;
        }
        button.success {
            background: #16a34a;
        }
        button.success:hover {
            background: #22c55e;
        }
        pre {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            color: #ce9178;
        }
        .code-label {
            color: #4ec9b0;
            font-weight: bold;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .data-table th {
            background: #1e1e1e;
            color: #569cd6;
            text-align: left;
            padding: 8px;
            border: 1px solid #3e3e42;
        }
        .data-table td {
            padding: 8px;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
        }
        .data-table tr:nth-child(even) {
            background: #252526;
        }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .success { color: #4ec9b0; }
        .info { color: #9cdcfe; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Profile System Debug Dashboard</h1>
        
        <div class="section">
            <h2>üìä System Statistics</h2>
            <div id="stats"></div>
            <button onclick="refreshStats()" class="success">üîÑ Refresh</button>
            <button onclick="compareData()" class="success">üîó Compare All</button>
            <button onclick="openConsole()">üìã Console</button>
        </div>

        <div class="section">
            <h2>üë§ Current User</h2>
            <div id="userInfo"></div>
        </div>

        <div class="section">
            <h2>üì¶ Orders Summary</h2>
            <div id="ordersSummary"></div>
            <button onclick="showAllOrders()" class="success">üìã Show All Orders</button>
        </div>

        <div class="section">
            <h2>üîî Notifications Summary</h2>
            <div id="notificationsSummary"></div>
            <button onclick="showAllNotifications()" class="success">üìã Show All Notifications</button>
        </div>

        <div class="section">
            <h2>üß™ Test Actions</h2>
            <button onclick="goToTestSetup()" class="success">üß™ Go to Test Setup</button>
            <button onclick="goToLogin()" class="success">üîê Go to Login</button>
            <button onclick="goToProfile()" class="success">üë§ Go to Profile</button>
            <button onclick="clearAllData()" class="danger">üóëÔ∏è Clear All Data</button>
        </div>

        <div class="section">
            <h2>üíæ Raw localStorage Data</h2>
            <div style="margin-bottom: 10px;">
                <button onclick="showRawData('users')" class="success">Users</button>
                <button onclick="showRawData('all_orders')" class="success">Orders</button>
                <button onclick="showRawData('admin_notifications')" class="success">Notifications</button>
                <button onclick="showRawData('client_auth')" class="success">Client Auth</button>
            </div>
            <pre id="rawData"><span class="warning">Click buttons above to see raw data...</span></pre>
        </div>
    </div>

    <script>
        function refreshStats() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const orders = JSON.parse(localStorage.getItem('all_orders') || '[]');
            const notifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');
            const clientAuth = JSON.parse(localStorage.getItem('client_auth') || 'null');

            let html = `
                <div class="stat ${users.length > 0 ? 'positive' : 'zero'}">üë• Users: ${users.length}</div>
                <div class="stat ${orders.length > 0 ? 'positive' : 'zero'}">üì¶ Orders: ${orders.length}</div>
                <div class="stat ${notifications.length > 0 ? 'positive' : 'zero'}">üîî Notifications: ${notifications.length}</div>
                <div class="stat ${clientAuth ? 'positive' : 'zero'}">üîê Logged In: ${clientAuth ? clientAuth.email : 'NO'}</div>
            `;

            // Status breakdown
            if (orders.length > 0) {
                const statuses = {};
                orders.forEach(o => {
                    statuses[o.status] = (statuses[o.status] || 0) + 1;
                });
                
                html += '<br/><br/><span class="code-label">Order Status Breakdown:</span><br/>';
                Object.entries(statuses).forEach(([status, count]) => {
                    html += `<div class="stat">${status}: ${count}</div>`;
                });
            }

            // Email matching check
            if (clientAuth && orders.length > 0) {
                const userOrders = orders.filter(o => 
                    o.customer?.email?.toLowerCase().trim() === clientAuth.email.toLowerCase().trim()
                );
                html += `<br/><br/><span class="code-label">Email Matching:</span><br/>`;
                html += `<div class="stat positive">Matched Orders: ${userOrders.length}/${orders.length}</div>`;
            }

            document.getElementById('stats').innerHTML = html;
        }

        function showAllOrders() {
            const orders = JSON.parse(localStorage.getItem('all_orders') || '[]');
            if (orders.length === 0) {
                alert('No orders found');
                return;
            }

            let html = '<table class="data-table"><thead><tr>';
            html += '<th>Order ID</th><th>Email</th><th>Status</th><th>Total</th><th>Created</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(o => {
                html += `<tr>
                    <td>${o.orderId}</td>
                    <td>${o.customer?.email || 'N/A'}</td>
                    <td>${o.status}</td>
                    <td>$${o.totals?.tot || o.total || 0}</td>
                    <td>${new Date(o.createdAt).toLocaleDateString()}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('stats').innerHTML = html;
        }

        function showAllNotifications() {
            const notifs = JSON.parse(localStorage.getItem('admin_notifications') || '[]');
            if (notifs.length === 0) {
                alert('No notifications found');
                return;
            }

            let html = '<table class="data-table"><thead><tr>';
            html += '<th>ID</th><th>Email</th><th>Title</th><th>Order ID</th><th>Date</th>';
            html += '</tr></thead><tbody>';

            notifs.forEach(n => {
                html += `<tr>
                    <td>${n.id}</td>
                    <td>${n.email || 'N/A'}</td>
                    <td>${n.title}</td>
                    <td>${n.orderId || 'N/A'}</td>
                    <td>${new Date(n.sentDate || n.timestamp).toLocaleDateString()}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('stats').innerHTML = html;
        }

        function compareData() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const orders = JSON.parse(localStorage.getItem('all_orders') || '[]');
            const notifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');

            let html = '<h3>Data Consistency Check:</h3>';

            // Check user-order matching
            let matchedOrders = 0;
            let unmatchedOrders = [];

            users.forEach(user => {
                const userEmails = [user.email, user.email.toLowerCase(), user.email.toLowerCase().trim()];
                const userOrderCount = orders.filter(o => 
                    userEmails.includes(o.customer?.email) || 
                    userEmails.includes(o.customer?.email?.toLowerCase()) ||
                    userEmails.includes(o.customer?.email?.toLowerCase().trim())
                ).length;
                
                html += `<div>
                    <span class="${userOrderCount > 0 ? 'success' : 'warning'}">
                    üë§ ${user.email}: ${userOrderCount} orders
                    </span>
                </div>`;
                
                matchedOrders += userOrderCount;
            });

            // Check unmatched orders
            unmatchedOrders = orders.filter(o => {
                const found = users.some(u => 
                    u.email.toLowerCase().trim() === o.customer?.email?.toLowerCase().trim()
                );
                return !found;
            });

            if (unmatchedOrders.length > 0) {
                html += `<div class="error">‚ö†Ô∏è Unmatched Orders: ${unmatchedOrders.length}</div>`;
                unmatchedOrders.forEach(o => {
                    html += `<div class="error">   - Order #${o.orderId} (${o.customer?.email})</div>`;
                });
            } else {
                html += `<div class="success">‚úÖ All orders matched with users</div>`;
            }

            // Check notifications
            let matchedNotifs = 0;
            let unmatchedNotifs = [];

            notifications.forEach(n => {
                const found = users.some(u => 
                    u.email.toLowerCase().trim() === n.email?.toLowerCase().trim()
                );
                if (found) matchedNotifs++;
                else unmatchedNotifs.push(n);
            });

            if (unmatchedNotifs.length > 0) {
                html += `<div class="warning">‚ö†Ô∏è Unmatched Notifications: ${unmatchedNotifs.length}</div>`;
            } else {
                html += `<div class="success">‚úÖ All notifications matched with users</div>`;
            }

            document.getElementById('stats').innerHTML = html;
        }

        function showRawData(key) {
            try {
                const data = localStorage.getItem(key);
                const parsed = data ? JSON.parse(data) : null;
                const rawEl = document.getElementById('rawData');
                
                if (!data) {
                    rawEl.innerHTML = `<span class="warning">No data for key: ${key}</span>`;
                } else {
                    rawEl.textContent = JSON.stringify(parsed, null, 2);
                }
            } catch (e) {
                document.getElementById('rawData').innerHTML = `<span class="error">Error: ${e.message}</span>`;
            }
        }

        function openConsole() {
            alert('Open DevTools: Press F12 or Ctrl+Shift+I\nGo to Console tab to see logs');
        }

        function goToTestSetup() {
            window.location.href = 'test-setup.html';
        }

        function goToLogin() {
            window.location.href = 'login.html';
        }

        function goToProfile() {
            window.location.href = 'profile.html';
        }

        function clearAllData() {
            if (!confirm('Clear all data?')) return;
            localStorage.clear();
            alert('All data cleared');
            location.reload();
        }

        // Initial load
        window.addEventListener('load', () => {
            refreshStats();
            
            const userInfo = JSON.parse(localStorage.getItem('client_auth') || 'null');
            if (userInfo) {
                document.getElementById('userInfo').innerHTML = `
                    <div class="stat positive">Email: ${userInfo.email}</div>
                    <div class="stat">Name: ${userInfo.fullName || 'N/A'}</div>
                    <div class="stat">Phone: ${userInfo.phone || 'N/A'}</div>
                    <div class="stat">Country: ${userInfo.country || 'N/A'}</div>
                `;
            } else {
                document.getElementById('userInfo').innerHTML = `<span class="warning">Not logged in</span>`;
            }
        });

        // Auto-refresh stats
        setInterval(refreshStats, 3000);
    </script>
</body>
</html>

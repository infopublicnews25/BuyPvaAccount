<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Sync Test - BuyPvaAccount</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .info-box {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .info-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .info-value {
            color: #666;
            font-family: monospace;
            word-break: break-all;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .data-card {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 6px;
        }
        .data-card h4 {
            margin: 0 0 10px 0;
            color: #667eea;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Email Sync & Integration Test</h1>
        <p class="subtitle">Verify email matching and order integration across the system</p>

        <div class="section">
            <h2>üìä System Status</h2>
            <div class="data-grid">
                <div class="data-card">
                    <h4>üë§ Current User</h4>
                    <div id="currentUserInfo">Not logged in</div>
                </div>
                <div class="data-card">
                    <h4>üì¶ Total Orders</h4>
                    <div id="totalOrdersInfo">0</div>
                </div>
                <div class="data-card">
                    <h4>üìß User Orders</h4>
                    <div id="userOrdersInfo">0</div>
                </div>
                <div class="data-card">
                    <h4>üîî User Notifications</h4>
                    <div id="userNotificationsInfo">0</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîç Email Matching Test</h2>
            <button class="btn-primary" onclick="testEmailMatching()">Test Email Matching</button>
            <button class="btn-primary" onclick="syncAllData()">Sync All Data</button>
            <div id="matchingResults"></div>
        </div>

        <div class="section">
            <h2>üìã All Orders for Current User</h2>
            <div id="ordersDisplay"></div>
        </div>

        <div class="section">
            <h2>üîî All Notifications for Current User</h2>
            <div id="notificationsDisplay"></div>
        </div>

        <div class="section">
            <h2>üîß Integration Check</h2>
            <button class="btn-success" onclick="checkIntegration()">Check Integration</button>
            <div id="integrationResults"></div>
        </div>

        <div class="section">
            <h2>‚öôÔ∏è Manual Sync Operations</h2>
            <button class="btn-primary" onclick="normalizeAllEmails()">Normalize All Emails (Lowercase)</button>
            <button class="btn-primary" onclick="linkOrdersToNotifications()">Link Orders to Notifications</button>
            <button class="btn-success" onclick="autoSyncForNextTime()">Setup Auto-Sync</button>
            <div id="syncResults"></div>
        </div>
    </div>

    <script>
        let currentUser = null;

        function init() {
            currentUser = JSON.parse(localStorage.getItem('client_auth') || 'null');
            refreshStatus();
        }

        function refreshStatus() {
            if (currentUser && currentUser.email) {
                document.getElementById('currentUserInfo').innerHTML = `
                    <div class="info-value">${currentUser.email}</div>
                `;

                const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
                const userOrders = allOrders.filter(o => 
                    o.customer?.email?.toLowerCase() === currentUser.email.toLowerCase()
                );
                const adminNotifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');
                const userNotifications = adminNotifications.filter(n => 
                    n.email?.toLowerCase() === currentUser.email.toLowerCase()
                );

                document.getElementById('totalOrdersInfo').innerHTML = allOrders.length;
                document.getElementById('userOrdersInfo').innerHTML = userOrders.length;
                document.getElementById('userNotificationsInfo').innerHTML = userNotifications.length;

                displayOrders();
                displayNotifications();
            } else {
                document.getElementById('currentUserInfo').innerHTML = `
                    <div class="error">‚ùå Not logged in</div>
                `;
            }
        }

        function testEmailMatching() {
            if (!currentUser) {
                alert('‚ùå Please login first');
                return;
            }

            const results = document.getElementById('matchingResults');
            const userEmail = currentUser.email.toLowerCase();
            const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
            const adminNotifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');

            let html = '<div class="success">‚úÖ Testing email matching...</div>';

            // Test orders
            const matchedOrders = allOrders.filter(o => {
                const orderEmail = o.customer?.email?.toLowerCase();
                return orderEmail === userEmail;
            });

            html += `
                <div class="info-box">
                    <div class="info-title">üì¶ Orders Matching</div>
                    <div class="info-value">
                        User Email: ${userEmail}<br>
                        Total Orders: ${allOrders.length}<br>
                        Matched Orders: ${matchedOrders.length}<br>
                        <br>
                        <strong>Matched Order IDs:</strong><br>
                        ${matchedOrders.length > 0 ? matchedOrders.map(o => o.orderId).join('<br>') : 'None'}
                    </div>
                </div>
            `;

            // Test notifications
            const matchedNotifications = adminNotifications.filter(n => 
                n.email?.toLowerCase() === userEmail
            );

            html += `
                <div class="info-box">
                    <div class="info-title">üîî Notifications Matching</div>
                    <div class="info-value">
                        User Email: ${userEmail}<br>
                        Total Notifications: ${adminNotifications.length}<br>
                        Matched Notifications: ${matchedNotifications.length}<br>
                        <br>
                        <strong>Matched Notification IDs:</strong><br>
                        ${matchedNotifications.length > 0 ? matchedNotifications.map(n => n.id).join('<br>') : 'None'}
                    </div>
                </div>
            `;

            results.innerHTML = html;
            console.log('‚úÖ Matching test complete');
        }

        function normalizeAllEmails() {
            if (!confirm('This will normalize all emails to lowercase. Continue?')) return;

            try {
                // Normalize orders
                const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
                allOrders.forEach(order => {
                    if (order.customer?.email) {
                        order.customer.email = order.customer.email.toLowerCase();
                    }
                });
                localStorage.setItem('all_orders', JSON.stringify(allOrders));

                // Normalize notifications
                const adminNotifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');
                adminNotifications.forEach(notif => {
                    if (notif.email) {
                        notif.email = notif.email.toLowerCase();
                    }
                });
                localStorage.setItem('admin_notifications', JSON.stringify(adminNotifications));

                // Normalize current user
                if (currentUser?.email) {
                    currentUser.email = currentUser.email.toLowerCase();
                    localStorage.setItem('client_auth', JSON.stringify(currentUser));
                }

                showSync('‚úÖ All emails normalized to lowercase!');
                refreshStatus();
            } catch (e) {
                showSync('‚ùå Error: ' + e.message);
            }
        }

        function linkOrdersToNotifications() {
            if (!confirm('Link all orders to their notifications? Continue?')) return;

            try {
                const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
                const adminNotifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');

                // Link notifications to orders
                adminNotifications.forEach(notif => {
                    if (notif.orderId) {
                        const order = allOrders.find(o => o.orderId === notif.orderId);
                        if (order && !notif.linkedOrder) {
                            notif.linkedOrder = {
                                orderId: order.orderId,
                                status: order.status,
                                total: order.total,
                                createdAt: order.createdAt
                            };
                        }
                    }
                });

                localStorage.setItem('admin_notifications', JSON.stringify(adminNotifications));

                showSync(`‚úÖ Linked ${adminNotifications.filter(n => n.linkedOrder).length} notifications to orders!`);
                refreshStatus();
            } catch (e) {
                showSync('‚ùå Error: ' + e.message);
            }
        }

        function syncAllData() {
            try {
                normalizeAllEmails();
                linkOrdersToNotifications();
                checkIntegration();
                refreshStatus();
            } catch (e) {
                showSync('‚ùå Sync error: ' + e.message);
            }
        }

        function checkIntegration() {
            if (!currentUser) {
                alert('‚ùå Please login first');
                return;
            }

            const results = document.getElementById('integrationResults');
            const userEmail = currentUser.email.toLowerCase();
            const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
            const adminNotifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');

            const userOrders = allOrders.filter(o => o.customer?.email?.toLowerCase() === userEmail);
            const userNotifs = adminNotifications.filter(n => n.email?.toLowerCase() === userEmail);

            let html = '<div class="success">‚úÖ Integration Check Results</div>';

            // Check each order has notifications
            userOrders.forEach(order => {
                const orderNotifs = userNotifs.filter(n => n.orderId === order.orderId);
                html += `
                    <div class="info-box">
                        <div class="info-title">Order #${order.orderId}</div>
                        <div class="info-value">
                            Email: ${order.customer?.email}<br>
                            Status: ${order.status}<br>
                            Notifications: ${orderNotifs.length} ${orderNotifs.length > 0 ? '‚úÖ' : '‚ö†Ô∏è'}<br>
                            ${orderNotifs.length > 0 ? 'Notif IDs: ' + orderNotifs.map(n => n.id).join(', ') : 'No notifications'}
                        </div>
                    </div>
                `;
            });

            results.innerHTML = html;
        }

        function displayOrders() {
            if (!currentUser) return;

            const userEmail = currentUser.email.toLowerCase();
            const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
            const userOrders = allOrders.filter(o => o.customer?.email?.toLowerCase() === userEmail);

            const display = document.getElementById('ordersDisplay');
            
            if (userOrders.length === 0) {
                display.innerHTML = '<div class="error">No orders found for this email</div>';
                return;
            }

            display.innerHTML = userOrders.map(order => `
                <div class="info-box">
                    <div class="info-title">üì¶ ${order.orderId}</div>
                    <div class="info-value">
                        <strong>Email:</strong> ${order.customer?.email}<br>
                        <strong>Status:</strong> ${order.status}<br>
                        <strong>Total:</strong> $${order.total}<br>
                        <strong>Created:</strong> ${new Date(order.createdAt).toLocaleString()}<br>
                    </div>
                </div>
            `).join('');
        }

        function displayNotifications() {
            if (!currentUser) return;

            const userEmail = currentUser.email.toLowerCase();
            const adminNotifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');
            const userNotifs = adminNotifications.filter(n => n.email?.toLowerCase() === userEmail);

            const display = document.getElementById('notificationsDisplay');
            
            if (userNotifs.length === 0) {
                display.innerHTML = '<div class="error">No notifications found for this email</div>';
                return;
            }

            display.innerHTML = userNotifs.map(notif => `
                <div class="info-box">
                    <div class="info-title">${notif.icon || 'üì¢'} ${notif.title || 'Notification'}</div>
                    <div class="info-value">
                        <strong>ID:</strong> ${notif.id}<br>
                        <strong>Email:</strong> ${notif.email}<br>
                        <strong>Message:</strong> ${notif.message}<br>
                        <strong>Order ID:</strong> ${notif.orderId || 'N/A'}<br>
                        <strong>Date:</strong> ${new Date(notif.sentDate || notif.timestamp).toLocaleString()}<br>
                    </div>
                </div>
            `).join('');
        }

        function autoSyncForNextTime() {
            // Add auto-sync on page load
            const syncCode = `
// Auto-sync notifications on profile page load
function autoSyncNotifications() {
    const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
    const adminNotifications = JSON.parse(localStorage.getItem('admin_notifications') || '[]');
    
    // Normalize all emails to lowercase
    allOrders.forEach(o => {
        if (o.customer?.email) o.customer.email = o.customer.email.toLowerCase();
    });
    adminNotifications.forEach(n => {
        if (n.email) n.email = n.email.toLowerCase();
    });
    
    localStorage.setItem('all_orders', JSON.stringify(allOrders));
    localStorage.setItem('admin_notifications', JSON.stringify(adminNotifications));
}

// Call this in profile.html on page load
autoSyncNotifications();
            `;

            const div = document.getElementById('syncResults');
            div.innerHTML = `
                <div class="success">‚úÖ Auto-sync code ready</div>
                <div class="code-block">${syncCode}</div>
                <p style="margin-top: 10px; color: #666;">Add this code to profile.html at the start of DOMContentLoaded event</p>
            `;
        }

        function showSync(message) {
            const div = document.getElementById('syncResults');
            div.innerHTML = `<div class="${message.includes('‚úÖ') ? 'success' : 'error'}">${message}</div>`;
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
